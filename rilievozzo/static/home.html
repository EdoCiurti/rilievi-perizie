<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Rilievi & Perizie</title>
  <link rel="stylesheet" href="stile.css">
  <link rel="stylesheet" href="home.css">
  <script src="libreria.js"></script>
  <script src="home.js"></script>
  <link rel="icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <!-- Aggiungi questi script sotto la tua inclusione di Leaflet nel <head> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <!-- Librerie per generazione report -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
   
  </style>
</head>

<body class="bg-gray-100">
  <!-- Background Shapes -->
  <div class="bg-shapes">
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
  </div>

  <!-- Modern Navbar -->
  <nav class="navbar-fixed">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <a href="#" class="navbar-logo">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
          <path d="M12 2L4 5V11.09C4 16.14 7.41 20.85 12 22C16.59 20.85 20 16.14 20 11.09V5L12 2Z" fill="currentColor"
            opacity="0.4" />
          <path
            d="M12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17Z"
            fill="currentColor" />
          <path
            d="M14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6193 14.5 9.5 13.3807 9.5 12C9.5 10.6193 10.6193 9.5 12 9.5"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <span>Rilievi & Perizie</span>
      </a>

      <button id="mobileMenuToggle"
        class="md:hidden flex items-center px-3 py-2 border rounded text-gray-500 border-gray-500 hover:text-blue-500 hover:border-blue-500">
        <i class="fas fa-bars"></i>
      </button>

      <ul class="navbar-menu hidden md:flex">
        <li class="navbar-menu-item">
          <a href="#" id="menuDashboard" class="navbar-menu-link active">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="navbar-menu-item">
          <a href="#" id="menuPerizie" class="navbar-menu-link">
            <i class="fas fa-map-marked-alt"></i>
            <span>Perizie</span>
          </a>
        </li>
        <li class="navbar-menu-item">
          <a href="#" id="menuClienti" class="navbar-menu-link">
            <i class="fas fa-users"></i>
            <span>Clienti</span>
          </a>
        </li>
        <li class="navbar-menu-item">
          <a href="#" id="menuReportistica" class="navbar-menu-link">
            <i class="fas fa-chart-bar"></i>
            <span>Reportistica</span>
          </a>
        </li>
      </ul>

      <div class="navbar-right">
        <button id="themeToggleBtn" class="theme-toggle-btn">
          <i class="fas fa-moon"></i>
        </button>

        <div class="user-dropdown" id="userDropdown">
          <button class="user-dropdown-btn">
            <div class="avatar" id="userAvatar">
              U
            </div>
            <span id="username">Utente</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>

          <div class="user-dropdown-content">
            <div class="user-dropdown-item" id="profiloBtn">
              <i class="fas fa-user"></i>
              <span>Il mio profilo</span>
            </div>
            <div class="user-dropdown-item" id="cambiaPasswordBtn">
              <i class="fas fa-key"></i>
              <span>Cambia password</span>
            </div>
            <div class="user-dropdown-item danger" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i>
              <span>Disconnetti</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stats Cards -->
    <!-- SECTION: Stats Cards -->
    <section id="stats" class="mt-6 scroll-mt-20" style="visibility: hidden
      ;">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                <i class="fas fa-file-alt text-white"></i>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Perizie Totali</dt>
                  <dd id="perizie-totali" class="text-2xl font-semibold text-gray-900">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                <i class="fas fa-check-circle text-white"></i>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Perizie Completate</dt>
                  <dd id="perizie-completate" class="text-2xl font-semibold text-gray-900">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                <i class="fas fa-exclamation-circle text-white"></i>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Perizie Incompiute</dt>
                  <dd id="perizie-incompiute" class="text-2xl font-semibold text-gray-900">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin Map and Perizie Section -->
    <div id="map-and-list-container">
      <!-- Mappa (ora prima) -->
      <div id="admin-map-container" class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-map-marked-alt mr-2 text-blue-500"></i>
            Mappa delle Perizie
          </h2>
          <div class="flex items-center space-x-4">
            <select id="mapLayerSelector" class="border rounded px-3 py-1 text-sm">
              <option value="street">Mappa stradale</option>
              <option value="satellite">Satellite</option>
              <option value="terrain">Rilievo</option>
            </select>
            <select id="operatorFilter" class="border rounded px-3 py-1 text-sm">
              <option value="">Tutti gli operatori</option>
            </select>
          </div>
        </div>
        <div id="map" class="w-full"></div>
      </div>

      <!-- Lista Perizie (ora seconda) -->
      <div id="perizieListContainer" class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-list-alt mr-2 text-blue-500"></i>
            Lista Perizie
          </h2>
          <button id="nuovaPerizia" onclick="apriFomNuovaPerizia()"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center">
            <i class="fas fa-plus mr-2"></i> Nuova Perizia
          </button>
        </div>
        <div class="perizie-table-container overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ID
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Descrizione</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Cliente</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Operatore</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Stato</th>
              </tr>
            </thead>
            <tbody id="perizieList" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Caricamento perizie...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sezione Clienti -->
    <section id="clienti-section" class="hidden mt-8">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-users mr-2 text-blue-500"></i>
            Lista Clienti
          </h2>
        </div>

        <!-- Statistiche clienti -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-gray-50">
          <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-users text-blue-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Clienti Totali</h3>
                <p id="clientiTotali" class="text-xl font-semibold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
              <div class="p-3 bg-green-100 rounded-full">
                <i class="fas fa-check-circle text-green-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Clienti con Perizie Completate</h3>
                <p id="clientiCompletati" class="text-xl font-semibold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
              <div class="p-3 bg-yellow-100 rounded-full">
                <i class="fas fa-clock text-yellow-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Clienti con Perizie in Corso</h3>
                <p id="clientiInCorso" class="text-xl font-semibold">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista Clienti -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Cliente
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Perizie Totali
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Completate
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  In Corso
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Azioni
                </th>
              </tr>
            </thead>
            </thead>
            <tbody id="clientiList" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Caricamento clienti...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Sezione Mappa Perizie Full-Screen -->
    <section id="mappa-perizie-section" class="hidden mt-8">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-map-marked-alt mr-2 text-blue-500"></i>
            Mappa delle Perizie
          </h2>
          <div class="flex items-center space-x-4">
            <!-- Layer selector -->
            <select id="mapLayerSelectorFullscreen" class="border rounded px-3 py-1 text-sm">
              <option value="street">Mappa stradale</option>
              <option value="satellite">Satellite</option>
              <option value="terrain">Rilievo</option>
            </select>
            <!-- Operator filter only for admins -->
            <select id="operatorFilterFullscreen" class="border rounded px-3 py-1 text-sm">
              <option value="">Tutti gli operatori</option>
            </select>
          </div>
        </div>
        <div id="mapFullscreen" style="width: 100%; height: 75vh;"></div>
      </div>
    </section>

    <!-- Sezione Reportistica -->
    <section id="reportistica-section" class="hidden mt-96">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-chart-bar mr-2 text-blue-500"></i>
            Dashboard Reportistica
          </h2>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-gray-50">
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-tasks text-blue-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Completamento</h3>
                <p id="kpi-completion-rate" class="text-xl font-semibold">0%</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center">
              <div class="p-3 bg-green-100 rounded-full">
                <i class="fas fa-clock text-green-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Tempo Medio</h3>
                <p id="kpi-avg-time" class="text-xl font-semibold">0 giorni</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center">
              <div class="p-3 bg-purple-100 rounded-full">
                <i class="fas fa-map-marker-alt text-purple-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Zone Principali</h3>
                <p id="kpi-top-zones" class="text-xl font-semibold">--</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center">
              <div class="p-3 bg-yellow-100 rounded-full">
                <i class="fas fa-user-check text-yellow-600"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm text-gray-500">Top Operatore</h3>
                <p id="kpi-top-operator" class="text-xl font-semibold">--</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Chart 1: Trend Perizie -->
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h3 class="font-medium text-gray-700 mb-3">Trend Perizie per Mese</h3>
            <div id="chart-trend" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
              <canvas></canvas>
            </div>
          </div>

          <!-- Chart 2: Perizie per Stato -->
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h3 class="font-medium text-gray-700 mb-3">Perizie per Stato</h3>
            <div id="chart-status" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
              <canvas></canvas>
            </div>
          </div>

          <!-- Chart 3: Performance Operatori -->
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h3 class="font-medium text-gray-700 mb-3">Performance Operatori</h3>
            <div id="chart-operators" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
              <canvas></canvas>
            </div>
          </div>

          <!-- Chart 4: Mappa di Calore (Heatmap) -->
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h3 class="font-medium text-gray-700 mb-3">Distribuzione Geografica</h3>
            <div id="chart-geography" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
              <div class="text-gray-400">
                <i class="fas fa-map text-4xl"></i>
                <p class="mt-2">Mappa di distribuzione</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Report Generator -->
        <div class="p-6 border-t">
          <h3 class="font-medium text-gray-800 mb-4">Genera Report</h3>



          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Formato</label>
            <div class="flex space-x-2 mt-1">
              <button id="btn-pdf"
                class="flex-1 py-2 px-4 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100">
                <i class="far fa-file-pdf mr-1"></i> PDF
              </button>

            </div>
          </div>
        </div>
      </div>
      </div>
    </section>

  </main>

  <!-- Modal per i dettagli della perizia -->
  <div id="periziaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" class="text-xl font-bold text-blue-700">Dettagli Perizia</h2>
        <span class="close" onclick="chiudiModal('periziaModal')">&times;</span>
      </div>
      <div id="modal-content" class="space-y-4">
        <!-- I dettagli della perizia verranno inseriti qui -->
      </div>
      <div id="modal-images" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
        <!-- Le immagini verranno inserite qui -->
      </div>
    </div>
  </div>

  <!-- Modal per nuova perizia -->
  <div id="nuovaPeriziaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="chiudiModal('nuovaPeriziaModal')">&times;</span>
      <h2 class="text-xl font-bold mb-4">Nuova Perizia</h2>
      <form id="nuovaPeriziaForm" class="space-y-4">
        <div>
          <label for="descrizione" class="block text-sm font-medium text-gray-700">Descrizione</label>
          <textarea id="descrizione" name="descrizione" rows="3"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required></textarea>
        </div>

        <div>
          <label for="cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
          <input type="text" id="cliente" name="cliente"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <!-- Sostituisci i campi latitudine/longitudine con un campo indirizzo -->
        <div>
          <label for="indirizzo" class="block text-sm font-medium text-gray-700">Indirizzo</label>
          <input type="text" id="indirizzo" name="indirizzo"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required placeholder="Via, numero civico, città, CAP">
          <div class="mt-1 text-sm text-gray-500">Inserisci l'indirizzo completo del luogo della perizia</div>
        </div>

        <!-- Aggiungi campi nascosti per le coordinate che verranno popolati dopo il geocoding -->
        <input type="hidden" id="latitudine" name="latitudine">
        <input type="hidden" id="longitudine" name="longitudine">

        <div>
          <label for="stato" class="block text-sm font-medium text-gray-700">Stato</label>
          <select id="stato" name="stato"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="In attesa">In attesa</option>
            <option value="In corso">In corso</option>
            <option value="Completata">Completata</option>
          </select>
        </div>

        <div class="border-t border-gray-200 pt-4">
          <h3 class="text-lg font-medium text-gray-900 mb-2">Immagini</h3>
          <div id="immagini-container">
            <div class="immagine-gruppo mb-4 p-4 border border-gray-200 rounded-md">
              <div class="mb-2">
                <label class="block text-sm font-medium text-gray-700">Immagine</label>
                <input type="file"
                  class="immagine-file mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  accept="image/*">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Commento</label>
                <textarea
                  class="immagine-commento mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  rows="2"></textarea>
              </div>
              <div class="mt-2 hidden">
                <img class="img-preview rounded-md" src="#" alt="Preview">
              </div>
            </div>
          </div>

          <button type="button" id="aggiungiImmagine"
            class="mt-2 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-plus mr-2"></i> Aggiungi immagine
          </button>
        </div>

        <div class="pt-5 border-t border-gray-200">
          <div class <button type="button" onclick="chiudiModal('nuovaPeriziaModal')"
            class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Annulla
            </button>
            <button type="submit"
              class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Salva
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal per modifica perizia -->
  <div id="modificaPeriziaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="chiudiModal('modificaPeriziaModal')">&times;</span>
      <h2 class="text-xl font-bold mb-4">Modifica Perizia</h2>
      <form id="modificaPeriziaForm" class="space-y-4">
        <input type="hidden" id="perizia-id-modifica">

        <div>
          <label for="descrizione-modifica" class="block text-sm font-medium text-gray-700">Descrizione</label>
          <textarea id="descrizione-modifica" name="descrizione" rows="3"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required></textarea>
        </div>

        <div>
          <label for="cliente-modifica" class="block text-sm font-medium text-gray-700">Cliente</label>
          <input type="text" id="cliente-modifica" name="cliente"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <div>
          <label for="indirizzo-modifica" class="block text-sm font-medium text-gray-700">Indirizzo</label>
          <input type="text" id="indirizzo-modifica" name="indirizzo"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
          <div class="mt-1 text-sm text-gray-500">Indirizzo completo del luogo della perizia</div>
        </div>

        <input type="hidden" id="latitudine-modifica" name="latitudine">
        <input type="hidden" id="longitudine-modifica" name="longitudine">

        <div>
          <label for="stato-modifica" class="block text-sm font-medium text-gray-700">Stato</label>
          <select id="stato-modifica" name="stato"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="In attesa">In attesa</option>
            <option value="In corso">In corso</option>
            <option value="Completata">Completata</option>
          </select>
        </div>

        <div class="border-t border-gray-200 pt-4 mt-4">
          <h3 class="text-lg font-medium text-gray-900 mb-2">Immagini</h3>
          <div id="immagini-modifica-container">
            <!-- Le immagini esistenti e nuove verranno caricate qui via JavaScript -->
            <div class="flex items-center justify-center p-6 bg-gray-50 rounded-md">
              <div class="text-center text-gray-500">
                <i class="fas fa-images text-3xl mb-2"></i>
                <p>Caricamento immagini...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="pt-5 border-t border-gray-200">
          <div class="flex justify-end">
            <button type="button" onclick="chiudiModal('modificaPeriziaModal')"
              class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Annulla
            </button>
            <button type="submit"
              class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Salva Modifiche
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal per conferma eliminazione -->
  <div id="eliminaPeriziaModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" onclick="chiudiModal('eliminaPeriziaModal')">&times;</span>
      <h2 class="text-xl font-bold mb-4 text-red-600">Eliminazione Perizia</h2>
      <p class="mb-4">Sei sicuro di voler eliminare questa perizia? Questa azione non può essere annullata.</p>

      <!-- Aggiungi container per info perizia -->
      <div id="perizia-info-container" class="mb-4"></div>

      <form id="eliminaPeriziaForm" class="space-y-4">
        <input type="hidden" id="perizia-id-elimina">

        <!-- Campo password per admin -->
        <div id="admin-password-container" class="mb-4 hidden">
          <label for="password-admin" class="block text-sm font-medium text-gray-700">Password Admin</label>
          <input type="password" id="password-admin"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
          <div class="mt-1 text-sm text-gray-500">Conferma con la tua password di amministratore</div>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" onclick="chiudiModal('eliminaPeriziaModal')"
            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Annulla
          </button>
          <button type="submit"
            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            Elimina
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal per i dettagli del cliente -->
  <div id="clienteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="cliente-modal-title" class="text-xl font-bold text-blue-700"></h2>
        <span class="close" onclick="chiudiModal('clienteModal')">&times;</span>
      </div>
      <div id="cliente-modal-content" class="space-y-4">
        <!-- I dettagli del cliente verranno inseriti qui -->
      </div>
      <div id="cliente-perizie-list" class="mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Perizie del Cliente</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrizione
                </th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operatore
                </th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
              </tr>
            </thead>
            <tbody id="cliente-perizie-body" class="bg-white divide-y divide-gray-200">
              <!-- Le perizie del cliente verranno inserite qui -->
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900">${perizia._id.substring(0, 8)}...</td>
                <td class="px-4 py-2 text-sm text-gray-500">${perizia.descrizione}</td>
                <td class="px-4 py-2 text-sm text-gray-500">${perizia.stato}</td>
                <td class="px-4 py-2 text-sm text-gray-500">${perizia.operatore}</td>
                <td class="px-4 py-2 text-sm text-gray-500">${perizia.createdAt}</td>
                <td class="px-4 py-2 text-sm text-gray-500">
                  <button class="text-blue-600 hover:text-blue-900"
                    onclick="mostraDettagliPeriziaConChiusura('${perizia._id}')">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per modifica cliente -->
  <div id="modificaClienteModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="text-xl font-bold text-blue-700">Modifica Cliente</h2>
        <span class="close" onclick="chiudiModal('modificaClienteModal')">&times;</span>
      </div>
      <form id="modificaClienteForm" class="space-y-4">
        <input type="hidden" id="cliente-nome-originale">

        <div>
          <label for="cliente-nome-modifica" class="block text-sm font-medium text-gray-700">Nome Cliente</label>
          <input type="text" id="cliente-nome-modifica" name="nome"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <div>
          <label for="cliente-note-modifica" class="block text-sm font-medium text-gray-700">Note</label>
          <textarea id="cliente-note-modifica" name="note"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            rows="3"></textarea>
        </div>

        <div class="flex justify-end pt-4">
          <button type="button" onclick="chiudiModal('modificaClienteModal')"
            class="mr-2 px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
            Annulla
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700">
            Salva Modifiche
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal per conferma eliminazione cliente -->
  <div id="eliminaClienteModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="text-xl font-bold text-red-700">Elimina Cliente</h2>
        <span class="close" onclick="chiudiModal('eliminaClienteModal')">&times;</span>
      </div>
      <div class="p-4">
        <p class="mb-4">Sei sicuro di voler eliminare questo cliente? Questa azione eliminerà anche tutte le perizie
          associate.</p>

        <div id="cliente-info-elimina" class="mb-4 p-3 bg-gray-100 rounded"></div>

        <!-- Campo password per admin -->
        <div id="admin-password-cliente-container" class="mb-4 hidden">
          <label for="password-admin-cliente" class="block text-sm font-medium text-gray-700">Password Admin</label>
          <input type="password" id="password-admin-cliente"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
          <div class="mt-1 text-sm text-gray-500">Conferma con la tua password di amministratore</div>
        </div>

        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="chiudiModal('eliminaClienteModal')"
            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Annulla
          </button>
          <button type="button" onclick="confermaEliminaCliente()"
            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
            Elimina
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per creazione utente (solo admin) -->
  <div id="creaUtenteModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" onclick="chiudiModal('creaUtenteModal')">&times;</span>
      <h2 class="text-xl font-bold mb-4 text-blue-600">
        <i class="fas fa-user-plus mr-2"></i>Crea Nuovo Utente
      </h2>

      <form id="creaUtenteForm" class="space-y-4" >
        <div> 
          <label for="username-nuovo" class="block text-sm font-medium text-gray-700">Nome utente</label>
          <input type="text" id="username-nuovo" name="username"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <div>
          <label for="password-nuovo" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="password-nuovo" name="password"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <div>
          <label for="confirm-password-nuovo" class="block text-sm font-medium text-gray-700">Conferma password</label>
          <input type="password" id="confirm-password-nuovo" name="confirmPassword"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            required>
        </div>

        <div>
          <label for="role-nuovo" class="block text-sm font-medium text-gray-700">Ruolo</label>
          <select id="role-nuovo" name="role"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="operatore">Operatore</option>
            <option value="admin">Amministratore</option>
          </select>
        </div>

        <div class="bg-blue-50 p-3 rounded-md">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-500"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm text-blue-700">
                L'utente dovrà cambiare la password al primo accesso.
              </p>
            </div>
          </div>
        </div>

        <div id="create-user-error-message" class="text-red-600 text-sm hidden"></div>

        <div class="flex justify-end pt-4">
          <button type="button" onclick="chiudiModal('creaUtenteModal')"
            class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
            Annulla
          </button>
          <button type="submit"
            class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            Crea Utente
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
       // Funzione per ricreare il modal "creaUtenteModal" se non esiste
   function assicuraModalCreaUtente() {
    if (!document.getElementById('creaUtenteModal')) {
      console.log("Ricreo il modal creaUtenteModal che manca");
      const modalHTML = `
    <div id="creaUtenteModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <!-- Contenuto del modal qui -->
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
  }

  // Esegui all'avvio
  document.addEventListener('DOMContentLoaded', assicuraModalCreaUtente);
  let userRole = 'user';
  let username = '';
  let map = null;
  let markers = [];
  const perizieData = [];


  // Coordinate della sede dell'ufficio (da modificare con le coordinate reali)
  const SEDE_UFFICIO = [41.9028, 12.4964]; // Roma come esempio

  // Variabili per i layer della mappa
  let streetLayer, satelliteLayer, terrainLayer;
  let currentLayer = null;

  async function checkLogin() {
    try {
      console.log("Checking login status...");
      const token = localStorage.getItem('token');

      if (!token) {
        console.warn("No authentication token found");
        window.location.href = "/login.html";
        return;
      }

      console.log("Token found, verifying with server...");
      const response = await inviaRichiesta("GET", "/api/checkAuth");

      if (response.status === 200) {
        const user = response.data;
        userRole = user.role || 'user';
        username = user.username || '';

        console.log(`Login successful: ${username} (${userRole})`);

        const usernameElem = document.getElementById("username");
        if (usernameElem) {
          usernameElem.innerText = "Ciao, " + username + "!";
        }

        // Initialize UI elements
        try {
          await caricaPerizie();
          initMap();

          // Hide operator filter for non-admins
          if (userRole !== 'admin') {
            const operatorFilter = document.getElementById('operatorFilter');
            if (operatorFilter) operatorFilter.style.display = 'none';
          }
        } catch (initError) {
          console.error("Error initializing UI:", initError);
          // Don't redirect on UI initialization errors
        }
      } else {
        console.warn("Authentication verification failed");
        localStorage.removeItem('token'); // Clear invalid token
        window.location.href = "/login.html";
      }
    } catch (err) {
      console.error("Authentication error:", err);
      localStorage.removeItem('token'); // Clear token on error
      window.location.href = "/login.html";
    }
    // Aggiungi alla fine della funzione checkLogin()
    if (userRole === 'admin') {
      // Se è admin, aggiungi l'opzione per creare nuovi utenti
      const userDropdownContent = document.querySelector('.user-dropdown-content');
      if (userDropdownContent) {
        // Verifica che l'elemento non esista già per evitare duplicati
        if (!document.getElementById('creaUtenteBtn')) {
          const createUserItem = document.createElement('div');
          createUserItem.className = 'user-dropdown-item';
          createUserItem.id = 'creaUtenteBtn';
          createUserItem.innerHTML = `
        <i class="fas fa-user-plus"></i>
        <span>Crea utente</span>
      `;
          createUserItem.addEventListener('click', mostraCreaUtenteModal);

          // Inserisci prima dell'elemento "Disconnetti"
          const logoutBtn = document.getElementById('logoutBtn');
          if (logoutBtn) {
            userDropdownContent.insertBefore(createUserItem, logoutBtn);
          } else {
            userDropdownContent.appendChild(createUserItem);
          }
        }
      }
    }
  }

  // Gestione tema dark per i grafici in profilo.html
function updateChartTheme(isDarkMode) {
if (window.Chart) {
  // Colori per tema scuro o chiaro
  const textColor = isDarkMode ? '#f8fafc' : '#1e293b';
  const gridColor = isDarkMode ? '#475569' : '#e5e7eb';
  
  // Aggiorna tutti i grafici esistenti
  Chart.helpers.each(Chart.instances, function(instance) {
    // Aggiorna le opzioni del grafico
    if (instance.options.scales && instance.options.scales.x) {
      instance.options.scales.x.ticks.color = textColor;
      instance.options.scales.x.grid.color = gridColor;
    }
    
    if (instance.options.scales && instance.options.scales.y) {
      instance.options.scales.y.ticks.color = textColor;
      instance.options.scales.y.grid.color = gridColor;
    }
    
    if (instance.options.plugins && instance.options.plugins.legend) {
      instance.options.plugins.legend.labels.color = textColor;
    }
    
    instance.update();
  });
}
}

// Aggiungi questo alla funzione di toggle tema
document.getElementById('themeToggleBtn').addEventListener('click', function() {
const isDarkMode = document.body.classList.contains('dark');
updateChartTheme(isDarkMode);
});

// Esegui all'avvio
document.addEventListener('DOMContentLoaded', function() {
const isDarkMode = document.body.classList.contains('dark');
updateChartTheme(isDarkMode);
});

  function addPerizieMarkers() {
    // Pulisci i marker esistenti
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    // Ottieni le perizie da visualizzare
    let perizieFiltrate = perizieData;

    // Se non è admin, filtra solo le proprie perizie
    if (userRole !== 'admin') {
      perizieFiltrate = perizieData.filter(p => p.operatore === username);
    } else {
      // Se è admin, applica eventualmente il filtro per operatore
      const operatorFilter = document.getElementById('operatorFilter').value;
      if (operatorFilter) {
        perizieFiltrate = perizieData.filter(p => p.operatore === operatorFilter);
      }
    }

    // Definisci le icone personalizzate per ogni stato
    const iconaCompletata = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInCorso = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInAttesa = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Aggiungi i marker per ogni perizia
    perizieFiltrate.forEach(perizia => {
      // Verifica se la perizia ha coordinate valide
      if (perizia.coordinate && perizia.coordinate.length === 2) {
        // Scegli l'icona in base allo stato
        let icon;
        switch (perizia.stato) {
          case "Completata":
            icon = iconaCompletata;
            break;
          case "In corso":
            icon = iconaInCorso;
            break;
          default:
            icon = iconaInAttesa;
        }

        // Crea marker con l'icona appropriata
        const marker = L.marker(perizia.coordinate, { icon: icon })
          .addTo(map)
          .bindPopup(`<b>${perizia.descrizione}</b><br>
                      Cliente: ${perizia.cliente || 'N/D'}<br>
                      Stato: <span class="${perizia.stato === "Completata" ? "text-green-600 font-semibold" :
              perizia.stato === "In corso" ? "text-blue-600 font-semibold" :
                "text-yellow-600 font-semibold"
            }">${perizia.stato}</span><br>
                      <button class="text-blue-600 hover:underline mt-2" onclick="mostraDettagliPerizia('${perizia._id}')">
                        Vedi dettagli
                      </button>`);
        markers.push(marker);
      }
    });

    // Se ci sono marker, adatta la vista per mostrarli tutti
    if (markers.length > 0) {
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  // Aggiungi questa funzione per ottimizzare le mappe su dispositivi mobili
  function optimizeMapForMobile() {
    if (window.innerWidth < 768) {
      // Riduci lo zoom della mappa su mobile per mostrare un'area più ampia
      if (map) {
        const currentCenter = map.getCenter();
        const currentZoom = map.getZoom();
        map.setView(currentCenter, Math.max(currentZoom - 1, 8));
      }

      if (mapFullscreen) {
        const currentCenter = mapFullscreen.getCenter();
        const currentZoom = mapFullscreen.getZoom();
        mapFullscreen.setView(currentCenter, Math.max(currentZoom - 1, 8));
      }

      // Imposta altezze specifiche per mobile
      const mapElement = document.getElementById('map');
      if (mapElement) {
        mapElement.style.height = '300px';
      }

      const mapFullscreenElement = document.getElementById('mapFullscreen');
      if (mapFullscreenElement) {
        mapFullscreenElement.style.height = '50vh';
      }
    }
  }

  // Modifica la funzione initMap esistente per includere ottimizzazione mobile
  function initMap() {
    console.log("Initializing map...");

    // ... codice esistente ...

    // Aggiungi alla fine della funzione:
    optimizeMapForMobile();

    // Assicura che il controlli della mappa siano facilmente accessibili su mobile
    if (window.innerWidth < 768 && map) {
      const zoomControl = map.zoomControl;
      if (zoomControl) {
        map.removeControl(zoomControl);
        map.addControl(L.control.zoom({ position: 'bottomright' }));
      }
    }
  }
  // Gestione del pulsante Cambia Password
  document.addEventListener('DOMContentLoaded', function () {
    const cambiaPasswordBtn = document.getElementById('cambiaPasswordBtn');
    if (cambiaPasswordBtn) {
      cambiaPasswordBtn.addEventListener('click', function () {
        console.log("Redirezione a cambiaPassword.html");
        window.location.href = 'cambiaPassword.html';
      });
    }
  });

  // Migliora i modal per l'interazione touch
  function enhanceModalsForTouch() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      // Previeni lo scroll del body quando il modal è aperto
      modal.addEventListener('touchmove', function (e) {
        if (!modal.querySelector('.modal-content').contains(e.target)) {
          e.preventDefault();
        }
      }, { passive: false });

      // Aggiungi swipe down per chiudere su mobile
      let touchStartY = 0;
      let touchMoveY = 0;

      modal.addEventListener('touchstart', function (e) {
        touchStartY = e.touches[0].clientY;
      }, { passive: true });

      modal.addEventListener('touchmove', function (e) {
        touchMoveY = e.touches[0].clientY;
      }, { passive: true });

      modal.addEventListener('touchend', function (e) {
        if (touchMoveY - touchStartY > 100) { // Swipe verso il basso di almeno 100px
          if (modal.querySelector('.modal-content').scrollTop === 0) {
            // Chiudi solo se si è all'inizio del contenuto
            const modalId = modal.id;
            chiudiModal(modalId);
          }
        }
      }, { passive: true });
    });
  }

  // Modifica la funzione chiudiModal esistente
  function chiudiModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) modalContent.style.transform = 'scale(0.95)';

    setTimeout(() => {
      modal.style.display = 'none';
      // Riabilita lo scroll quando si chiude il modal
      document.body.style.overflow = '';
    }, 300);
  }

  // Modifica la funzione mostraModal esistente
  function mostraModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // Disabilita lo scroll del body su mobile
    if (window.innerWidth < 768) {
      document.body.style.overflow = 'hidden';
    }

    modal.style.display = 'flex';
    setTimeout(() => {
      modal.querySelector('.modal-content').style.transform = 'scale(1)';
    }, 10);
  }

  // Migliora la gestione dei form su dispositivi mobili
  function enhanceFormsForMobile() {
    const forms = document.querySelectorAll('form');

    forms.forEach(form => {
      // Ottimizza l'altezza dei textarea su mobile
      const textareas = form.querySelectorAll('textarea');
      if (window.innerWidth < 768) {
        textareas.forEach(textarea => {
          if (textarea.rows > 3) textarea.rows = 3;
        });
      }

      // Gestisci meglio il focus degli input su mobile
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        input.addEventListener('focus', function () {
          // Scorri per assicurarsi che l'elemento sia visibile quando si apre la tastiera
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    });
  }

  // Aggiungi funzione per adattare le tabelle su mobile
  function makeTablesResponsive() {
    const tables = document.querySelectorAll('table');

    if (window.innerWidth < 768) {
      tables.forEach(table => {
        // Assicurati che la tabella possa essere scorsa orizzontalmente su mobile
        const wrapper = document.createElement('div');
        wrapper.className = 'overflow-x-auto w-full';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);

        // Identifica e adatta le colonne meno importanti su mobile
        const headerCells = table.querySelectorAll('th');
        if (headerCells.length > 4) {
          // Se ci sono più di 4 colonne, nascondi alcune colonne meno importanti su mobile
          const lessImportantColumns = [2, 3]; // Indici colonne da nascondere (personalizza in base alle tue esigenze)

          lessImportantColumns.forEach(colIndex => {
            if (headerCells[colIndex]) {
              headerCells[colIndex].classList.add('hidden-mobile');

              // Nascondi anche le celle corrispondenti nel body
              const rows = table.querySelectorAll('tbody tr');
              rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells[colIndex]) {
                  cells[colIndex].classList.add('hidden-mobile');
                }
              });
            }
          });
        }
      });
    }
  }

  // Funzione principale per inizializzare tutte le ottimizzazioni responsive
  function initResponsiveFeatures() {
    const isMobile = window.innerWidth < 768;
    const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;

    // Applica stili di base al body
    document.body.classList.toggle('mobile-device', isMobile);
    document.body.classList.toggle('tablet-device', isTablet);

    // Ottimizza elementi UI per dispositivo
    adjustUIForDevice(isMobile, isTablet);

    // Ottimizza mappe
    optimizeMapForMobile();

    // Migliora modal per touch
    enhanceModalsForTouch();

    // Migliora form per mobile
    enhanceFormsForMobile();

    // Adatta tabelle
    makeTablesResponsive();

    // Aggiungi altre ottimizzazioni responsive qui
  }

  // Esegui all'avvio e al ridimensionamento della finestra
  document.addEventListener('DOMContentLoaded', initResponsiveFeatures);
  window.addEventListener('resize', debounce(initResponsiveFeatures, 250));

  // Funzione di utilità per limitare la frequenza delle chiamate su resize
  function debounce(func, wait) {
    let timeout;
    return function () {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        func.apply(context, args);
      }, wait);
    };
  }
  // Fix for the caricaPerizie function
  async function caricaPerizie() {
    try {
      const response = await inviaRichiesta("GET", "/api/perizie");
      if (response.status === 200) {
        const perizie = response.data || [];
        // Salva i dati delle perizie per uso successivo
        perizieData.length = 0;
        perizieData.push(...perizie);

        // Aggiorna i contatori
        const perizieCompletate = perizie.filter(p => p.stato === "Completata").length;
        const perizieIncompiute = perizie.length - perizieCompletate;

        document.getElementById("perizie-totali").innerText = perizie.length;
        document.getElementById("perizie-completate").innerText = perizieCompletate;
        document.getElementById("perizie-incompiute").innerText = perizieIncompiute;

        // Popola la lista degli operatori per il filtro (solo per admin)
        if (userRole === 'admin') {
          const operatori = [...new Set(perizie.map(p => p.operatore).filter(Boolean))];
          const operatorFilter = document.getElementById('operatorFilter');
          operatorFilter.innerHTML = '<option value="">Tutti gli operatori</option>';

          operatori.forEach(operatore => {
            const option = document.createElement('option');
            option.value = operatore;
            option.textContent = operatore;
            operatorFilter.appendChild(option);
          });

          // Aggiungi event listener per il filtro
          operatorFilter.addEventListener('change', addPerizieMarkers);
        }

        // Popola la lista perizie
        const perizieList = document.getElementById("perizieList");

        // Check if the element with id "emptyState" exists before referencing it
        const emptyStateEl = document.getElementById("emptyState");
        if (!perizie.length && emptyStateEl) {
          emptyStateEl.classList.remove("hidden");
          perizieList.innerHTML = "";
          return;
        }

        perizieList.innerHTML = "";

        // Filtra le perizie se l'utente è un operatore
        const perizieVisibili = userRole === 'admin' ? perizie : perizie.filter(p => p.operatore === username);

        perizieVisibili.forEach(perizia => {
          const statoClass =
            perizia.stato === "Completata" ? "bg-green-100 text-green-800" :
              perizia.stato === "In corso" ? "bg-blue-100 text-blue-800" :
                "bg-yellow-100 text-yellow-800";

          const row = document.createElement("tr");
          row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${perizia._id.substring(0, 8)}...</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${perizia.descrizione}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${perizia.cliente || "N/D"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${perizia.operatore || "N/D"}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoClass}">
                  ${perizia.stato || "In attesa"}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="mostraDettagliPerizia('${perizia._id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="text-green-600 hover:text-green-900 mr-3" onclick="modificaPerizia('${perizia._id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-600 hover:text-red-900" onclick="eliminaPerizia('${perizia._id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
          perizieList.appendChild(row);
        });

        // Check if element exists before trying to access its classList
        const perizieTableContainer = document.querySelector('.perizie-table-container');
        if (perizieTableContainer) {
          if (perizieVisibili.length > 5) {
            perizieTableContainer.classList.add('has-scroll');
          } else {
            perizieTableContainer.classList.remove('has-scroll');
          }
        }

        return perizie;
      }
    } catch (err) {
      console.error("Errore nel caricamento delle perizie:", err);
      const perizieList = document.getElementById("perizieList");
      if (perizieList) {
        perizieList.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-red-500">
                Errore nel caricamento delle perizie. Riprova più tardi.
              </td>
            </tr>
          `;
      }
    }
  }

  // Modifica della funzione mostraDettagliPerizia per aggiungere i bottoni
  async function mostraDettagliPerizia(id) {
    try {
      const response = await inviaRichiesta("GET", `/api/perizie/${id}`);
      if (response.status === 200) {
        const perizia = response.data;

        // Aggiorna il modal con i nuovi stili
        const modal = document.getElementById('periziaModal');
        const modalContent = modal.querySelector('.modal-content');

        // Popola il contenuto del modal
        document.getElementById('modal-title').textContent = perizia.descrizione;

        // Ottieni i permessi: l'utente può modificare se è admin o se è l'operatore della perizia
        const canEdit = userRole === 'admin' || perizia.operatore === username;

        let contenuto = `
<div class="bg-white p-6 rounded-xl shadow space-y-6">
  <!-- Info principali -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    <div class="flex items-center space-x-3">
      <div class="p-3 bg-blue-100 rounded-full">
        <i class="fas fa-user text-blue-600 text-lg"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500 font-medium">Cliente</p>
        <p class="text-base text-gray-900 font-semibold">${perizia.cliente || 'N/D'}</p>
      </div>
    </div>
    <div class="flex items-center space-x-3">
      <div class="p-3 bg-green-100 rounded-full">
        <i class="fas fa-user-cog text-green-600 text-lg"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500 font-medium">Operatore</p>
        <p class="text-base text-gray-900 font-semibold">${perizia.operatore || 'N/D'}</p>
      </div>
    </div>
    <div class="flex items-center space-x-3">
      <div class="p-3 bg-yellow-100 rounded-full">
        <i class="fas fa-flag text-yellow-600 text-lg"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500 font-medium">Stato</p>
        <p class="text-base text-gray-900 font-semibold">${perizia.stato || 'In attesa'}</p>
      </div>
    </div>
    <div class="flex items-center space-x-3">
      <div class="p-3 bg-purple-100 rounded-full">
        <i class="fas fa-calendar-day text-purple-600 text-lg"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500 font-medium">Data</p>
        <p class="text-base text-gray-900 font-semibold">${new Date(perizia.createdAt).toLocaleDateString('it-IT')}</p>
      </div>
    </div>
    <div class="flex items-center space-x-3 col-span-1 sm:col-span-2">
      <div class="p-3 bg-red-100 rounded-full">
        <i class="fas fa-map-marker-alt text-red-600 text-lg"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500 font-medium">Indirizzo</p>
        <p class="text-base text-gray-900 font-semibold">${perizia.indirizzo || 'Non specificato'}</p>
      </div>
    </div>
  </div>

  <!-- Descrizione -->
  <div>
    <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
      <i class="fas fa-info-circle text-blue-500 mr-2"></i>
      Descrizione
    </h3>
    <p class="text-gray-700 text-sm leading-relaxed">${perizia.descrizione}</p>
  </div>
  
  <!-- Bottoni azioni -->
  ${canEdit ? `
  <div class="flex justify-end space-x-3 pt-3 border-t border-gray-200">
    <button onclick="modificaPerizia('${perizia._id}'); chiudiModal('periziaModal');" 
      class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-md flex items-center">
      <i class="fas fa-edit mr-2"></i> Modifica
    </button>
    <button onclick="eliminaPerizia('${perizia._id}'); chiudiModal('periziaModal');" 
      class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-md flex items-center">
      <i class="fas fa-trash mr-2"></i> Elimina
    </button>
  </div>
  ` : ''}
</div>
`;

        document.getElementById('modal-content').innerHTML = contenuto;

        // Popola la galleria di immagini
        const imageContainer = document.getElementById('modal-images');
        imageContainer.innerHTML = '';

        if (perizia.immagini && perizia.immagini.length) {
          perizia.immagini.forEach(img => {
            const imgDiv = document.createElement('div');
            imgDiv.classList.add('bg-gray-100', 'p-2', 'rounded');

            imgDiv.innerHTML = `
<div class="overflow-hidden rounded-xl shadow-sm">
  <img src="${img.url}" alt="${img.descrizione || 'Immagine'}" class="object-cover w-full h-48">
</div>
<p class="mt-2 text-xs text-gray-600 text-center">${img.commento || ''}</p>
`;

            imageContainer.appendChild(imgDiv);
          });
        } else {
          imageContainer.innerHTML = '<p class="text-gray-500 text-center col-span-3">Nessuna immagine disponibile</p>';
        }

        // Mostra il modal con display flex per il centramento
        modal.style.display = 'flex';

        // Applica l'animazione di apertura
        setTimeout(() => {
          modalContent.style.transform = 'scale(1)';
        }, 10);
      } else {
        alert('Errore nel caricamento dei dettagli della perizia');
      }
    } catch (err) {
      console.error("Errore nel caricamento dei dettagli della perizia:", err);
      alert('Errore nel caricamento dei dettagli della perizia');
    }
  }
  // Inizializza funzionalità responsive
  document.addEventListener('DOMContentLoaded', function () {
    console.log("Inizializzazione funzionalità responsive");

    // 1. Aggiungi pulsante menu hamburger per mobile
    const navbar = document.querySelector('.navbar-fixed .container');
    if (navbar) {
      const mobileMenuButton = document.createElement('button');
      mobileMenuButton.id = 'mobileMenuToggle';
      mobileMenuButton.className = 'md:hidden flex items-center px-3 py-2 border rounded text-gray-500 border-gray-500 hover:text-blue-500 hover:border-blue-500';
      mobileMenuButton.innerHTML = '<i class="fas fa-bars"></i>';

      const navbarLogo = navbar.querySelector('.navbar-logo');
      if (navbarLogo) {
        navbar.insertBefore(mobileMenuButton, navbarLogo.nextSibling);
      } else {
        navbar.prepend(mobileMenuButton);
      }

      // Gestisci clic su menu hamburger
      mobileMenuButton.addEventListener('click', function () {
        const navbarMenu = document.querySelector('.navbar-menu');
        if (navbarMenu) {
          navbarMenu.classList.toggle('hidden');
          navbarMenu.classList.toggle('mobile-menu-open');
        }
      });
    }

    // 2. Ottimizza layout per mobile
    if (window.innerWidth < 768) {
      const mapAndListContainer = document.getElementById('map-and-list-container');
      if (mapAndListContainer) {
        mapAndListContainer.style.gridTemplateColumns = '1fr';
      }

      // Riduci spaziature eccessive
      document.querySelectorAll('.px-6, .py-6').forEach(el => {
        el.classList.remove('px-6', 'py-6');
        el.classList.add('px-3', 'py-3');
      });
    }

    // 3. Inizializza altre ottimizzazioni responsive
    initResponsiveFeatures();
  });

  // Modifica della funzione apriFomNuovaPerizia per rilevare automaticamente la posizione
  function apriFomNuovaPerizia() {
    // Reset del form
    document.getElementById('nuovaPeriziaForm').reset();

    // Controlla se l'elemento per la selezione operatore esiste già
    let operatoreField = document.getElementById('operatore-select-container');

    // Se l'utente è admin e l'elemento non esiste, crealo
    if (userRole === 'admin' && !operatoreField) {
      const container = document.createElement('div');
      container.id = 'operatore-select-container';
      container.innerHTML = `
      <label for="operatore" class="block text-sm font-medium text-gray-700">Assegna a operatore</label>
      <select id="operatore" name="operatore"
        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
        <option value="">Caricamento operatori...</option>
      </select>
    `;

      // Inserisci prima del campo stato
      const statoField = document.querySelector('#nuovaPeriziaForm div:has(#stato)');
      if (statoField) {
        statoField.parentNode.insertBefore(container, statoField);
      }

      // Carica gli operatori
      loadOperatori('operatore');
    } else if (userRole !== 'admin' && operatoreField) {
      // Se non è admin e l'elemento esiste, rimuovilo
      operatoreField.remove();
    }

    // Rimuovi tutti i blocchi di immagini tranne il primo
    const immaginiContainer = document.getElementById('immagini-container');
    while (immaginiContainer.children.length > 1) {
      immaginiContainer.removeChild(immaginiContainer.lastChild);
    }
    // Reset preview
    const previewElement = document.querySelector('.img-preview');
    if (previewElement && previewElement.parentElement) {
      previewElement.parentElement.classList.add('hidden');
    }

    // Apri il modal
    document.getElementById('nuovaPeriziaModal').style.display = 'flex';

    // Aggiorna il campo indirizzo con un messaggio di caricamento
    const indirizzoField = document.getElementById('indirizzo');
    indirizzoField.value = "Rilevamento posizione in corso...";
    indirizzoField.disabled = true;

    // Mostra un indicatore di caricamento
    const indicatore = document.createElement('div');
    indicatore.id = 'geocoding-loader';
    indicatore.className = 'text-sm text-blue-600 mt-1 flex items-center';
    indicatore.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Acquisizione posizione in corso...';
    indirizzoField.parentNode.appendChild(indicatore);

    // Usa la geolocalizzazione per compilare automaticamente coordinate e indirizzo
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          // Salva le coordinate nei campi nascosti
          document.getElementById('latitudine').value = position.coords.latitude;
          document.getElementById('longitudine').value = position.coords.longitude;

          // Esegui il reverse geocoding per ottenere l'indirizzo
          try {
            const indirizzo = await reverseGeocode(position.coords.latitude, position.coords.longitude);
            indirizzoField.value = indirizzo;

            // Rimuovi l'indicatore di caricamento
            document.getElementById('geocoding-loader').remove();
            indirizzoField.disabled = false;
          } catch (error) {
            console.error("Errore nel reverse geocoding:", error);
            indirizzoField.value = `Coordinate: ${position.coords.latitude}, ${position.coords.longitude}`;

            // Aggiorna l'indicatore per mostrare l'errore
            document.getElementById('geocoding-loader').innerHTML =
              '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> ' +
              'Impossibile determinare l\'indirizzo preciso. Puoi modificarlo manualmente.';
            indirizzoField.disabled = false;
          }
        },
        (error) => {
          console.error("Errore di geolocalizzazione:", error);

          // Mostra un messaggio di errore appropriato
          indirizzoField.value = "";
          indirizzoField.disabled = false;

          // Aggiorna l'indicatore per mostrare l'errore
          document.getElementById('geocoding-loader').innerHTML =
            '<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> ' +
            'Impossibile rilevare la posizione. Inserisci l\'indirizzo manualmente.';

          // Avvisa l'utente del problema
          if (error.code === 1) {
            // Permesso negato
            alert('Per utilizzare la funzione di geolocalizzazione automatica, concedi il permesso di accesso alla posizione.');
          } else {
            // Altri errori
            alert('Non è stato possibile rilevare la tua posizione. Inserisci l\'indirizzo manualmente.');
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      // Geolocalizzazione non supportata
      indirizzoField.value = "";
      indirizzoField.disabled = false;

      // Aggiorna l'indicatore per mostrare l'errore
      document.getElementById('geocoding-loader').innerHTML =
        '<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> ' +
        'Il tuo browser non supporta la geolocalizzazione. Inserisci l\'indirizzo manualmente.';
    }
  }

  async function loadOperatori(selectId) {
    try {
      const response = await fetch('/api/users?role=operatore', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const users = await response.json();
        const select = document.getElementById(selectId);

        // Pulisci il select
        select.innerHTML = '';

        // Aggiungi l'opzione predefinita
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Seleziona operatore';
        select.appendChild(defaultOption);

        // Aggiungi gli operatori
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.username;
          option.textContent = user.username;
          select.appendChild(option);
        });
      } else {
        console.error('Errore nel caricamento degli operatori');
      }
    } catch (err) {
      console.error('Errore nel caricamento degli operatori:', err);
    }
  }

  // Funzione per convertire coordinate in indirizzo (reverse geocoding)
  async function reverseGeocode(lat, lng) {
    try {
      // Utilizziamo l'API di OpenStreetMap (Nominatim) per il reverse geocoding
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
      const data = await response.json();

      if (data && data.display_name) {
        return data.display_name;
      } else {
        throw new Error('Indirizzo non trovato');
      }
    } catch (error) {
      console.error('Errore nel reverse geocoding:', error);
      throw error;
    }
  }

  // Fix the logout button to ONLY handle logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem('token');
    window.location.href = "/login.html";
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    localStorage.removeItem('token'); // Rimuovi il token dal localStorage
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Elaborazione...';

    try {
      // Ottieni l'indirizzo e fai il geocoding
      const indirizzo = document.getElementById('indirizzo').value;
      const coordinate = await geocodeIndirizzo(indirizzo);

      // Popola i campi nascosti con le coordinate
      document.getElementById('latitudine').value = coordinate.lat;
      document.getElementById('longitudine').value = coordinate.lng;

      const formData = new FormData();

      // Raccogli i dati generali della perizia
      formData.append('descrizione', document.getElementById('descrizione').value);
      formData.append('cliente', document.getElementById('cliente').value);
      formData.append('stato', document.getElementById('stato').value);
      formData.append('indirizzo', indirizzo);
      formData.append('coordinate', JSON.stringify([coordinate.lat, coordinate.lng]));

      // Raccogli le immagini e i commenti
      const immaginiGruppi = document.querySelectorAll('.immagine-gruppo');

      // Importante: utilizziamo lo stesso nome campo 'immagini' per tutti i file
      immaginiGruppi.forEach((gruppo) => {
        const fileInput = gruppo.querySelector('.immagine-file');
        const commento = gruppo.querySelector('.immagine-commento').value;

        if (fileInput.files.length > 0) {
          // Tutte le immagini vanno nello stesso campo 'immagini'
          formData.append('immagini', fileInput.files[0]);
          // Tutti i commenti vanno nello stesso campo 'commenti'
          formData.append('commenti', commento);
        }
      });

      // Invia i dati al server
      const response = await fetch('/api/perizie', {
        method: 'POST',
        body: formData,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const responseData = await response.json();

        // Chiudi il modal
        chiudiModal('nuovaPeriziaModal');

        // Ricarica le perizie
        await caricaPerizie();

        // Se la mappa è inizializzata, centra sulle nuove coordinate
        if (map) {
          map.setView([coordinate.lat, coordinate.lng], 15);

          // Aggiorna i marker sulla mappa
          addPerizieMarkers();
        }

        alert('Perizia creata con successo!');
      } else {
        const errorData = await response.text();
        throw new Error(errorData);
      }
    } catch (err) {
      console.error('Errore:', err);
      alert('Errore: ' + (err.message || 'Si è verificato un problema durante la creazione della perizia'));
    } finally {
      // Ripristina il pulsante
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });

  // Funzione per aprire il modal di modifica
// Modifica la funzione di salvataggio della perizia
document.getElementById('modificaPeriziaForm').addEventListener('submit', async function(e) {
e.preventDefault();

const submitButton = this.querySelector('button[type="submit"]');
const originalButtonText = submitButton.innerHTML;
submitButton.disabled = true;
submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';

try {
  // Ottieni l'ID della perizia (importante!)
  const id = document.getElementById('perizia-id-modifica').value;
  
  // Crea un oggetto FormData
  const formData = new FormData();
  
  // Aggiungi l'ID della perizia (fondamentale!)
  formData.append('id', id);

  // Dati base della perizia
  formData.append('descrizione', document.getElementById('descrizione-modifica').value);
  formData.append('cliente', document.getElementById('cliente-modifica').value);
  formData.append('stato', document.getElementById('stato-modifica').value);
  formData.append('indirizzo', document.getElementById('indirizzo-modifica').value);

  // Coordinate
  const lat = parseFloat(document.getElementById('latitudine-modifica').value);
  const lng = parseFloat(document.getElementById('longitudine-modifica').value);
  if (!isNaN(lat) && !isNaN(lng)) {
    formData.append('coordinate', JSON.stringify([lat, lng]));
  }

  // Se admin, aggiungi il campo operatore
  if (userRole === 'admin') {
    const operatoreSelect = document.getElementById('operatore-modifica');
    if (operatoreSelect && operatoreSelect.value) {
      formData.append('operatore', operatoreSelect.value);
    }
  }

  // Aggiungi le immagini da eliminare
// Aggiungi le immagini da eliminare con informazioni complete
if (immaginiDaEliminare && immaginiDaEliminare.length > 0) {
formData.append('immaginiDaEliminare', JSON.stringify(immaginiDaEliminare));
}
  // Aggiungi le nuove immagini
  const fileInput = document.getElementById('immagini-modifica');
  if (fileInput && fileInput.files && fileInput.files.length > 0) {
    for (let i = 0; i < fileInput.files.length; i++) {
      formData.append('immagini', fileInput.files[i]);
    }
  }

  // Invia la richiesta con gestione errori migliorata
  const response = await fetch(`/api/perizie/${id}`, {  // Notare l'URI cambiato
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    },
    body: formData
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(errorText || 'Errore durante la modifica della perizia');
  }
  
  // Reset dell'array dopo il salvataggio
  immaginiDaEliminare = [];
  
  // Chiudi il modal e aggiorna i dati
  chiudiModal('modificaPeriziaModal');
  await caricaPerizie();
  
  // Mostra un messaggio di successo
  alert('La perizia è stata modificata con successo!');
  
} catch (err) {
  console.error('Dettagli errore:', err);
  alert('Errore: ' + (err.message || 'Si è verificato un problema durante l\'aggiornamento della perizia'));
} finally {
  submitButton.disabled = false;
  submitButton.innerHTML = originalButtonText;
}
});
// Aggiungi event listener ai pulsanti di eliminazione
document.querySelectorAll('.rimuovi-immagine-btn').forEach(btn => {
btn.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  
  const container = this.closest('.immagine-container');
  const imageId = container.dataset.id;
  const imagePath = container.dataset.path || container.querySelector('img').getAttribute('src');
  const filename = imagePath.split('/').pop(); // Estrai il nome del file dall'URL
  
  // Aggiungi informazioni complete sull'immagine all'array delle immagini da eliminare
  immaginiDaEliminare.push({
    id: imageId,
    path: imagePath,
    filename: filename
  });
  
  // Nascondi visivamente l'immagine
  container.style.opacity = '0.3';
  container.classList.add('to-be-removed');
  
  // Resto del codice esistente...
});
});

  // Update the eliminaPerizia function to properly handle both admin and operator roles
  async function eliminaPerizia(id) {
    try {
      // Ottieni password se sei admin
      let headers = {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      };

      if (userRole === 'admin') {
        const password = prompt("Inserisci la password dell'amministratore per confermare l'eliminazione:");
        if (!password) return; // Annulla se l'utente chiude il prompt
        headers['Admin-Password'] = password;
      }

      const response = await fetch(`/api/perizie/${id}`, {
        method: 'DELETE',
        headers: headers
      });

      // Gestisci sia risposte di testo che JSON
      let messaggio;
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const data = await response.json();
        messaggio = data.message;
      } else {
        messaggio = await response.text();
      }

      if (response.ok) {
        alert('Perizia eliminata con successo!');
        window.location.reload();
        // Aggiorna la lista delle perizie
        caricaPerizie();
      } else {
        alert(`Errore: ${messaggio}`);
      }
    } catch (err) {
      console.error('Errore durante l\'eliminazione:', err);
      alert('Si è verificato un errore durante l\'eliminazione della perizia.');
    }
  }

  // Funzione per chiudere un modal qualsiasi
  function chiudiModal(modalId) {
  }

  // Funzione per chiudere un modal qualsiasi
  function chiudiModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
  }

  // Chiudi il modal quando si clicca fuori dal contenuto
  window.addEventListener('click', function (event) {
    if (event.target.classList.contains('modal')) {
      const modal = event.target;
      const modalContent = modal.querySelector('.modal-content');
      modalContent.style.transform = 'scale(0.95)';

      setTimeout(() => {
        modal.style.display = 'none';
      }, 200);
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    localStorage.removeItem('token'); // Rimuovi il token dal localStorage
    window.location.href = "/login.html";
  });

  // Verifica autenticazione all'avvio
  checkLogin();

  // Aggiungi questo nella sezione script

  // Variabili globali per la gestione dei clienti
  let clientiData = [];
  let sezioneCorrente = 'dashboard';

  // Gestore per i click sulla navbar
  document.addEventListener('DOMContentLoaded', function () {
    // Rimuovi tutti gli event listener esistenti per sicurezza
    const menuClienti = document.getElementById('menuClienti');
    const oldMenuClienti = menuClienti.cloneNode(true);
    menuClienti.parentNode.replaceChild(oldMenuClienti, menuClienti);

    // Aggiungi nuovo event listener pulito
    const elementToClone = document.getElementById('menuClienti');
    if (elementToClone) {
      const clonedElement = elementToClone.cloneNode(true);
      clonedElement.addEventListener('click', function (e) {
        e.preventDefault();

        // Verifica che l'utente sia autenticato
        if (!localStorage.getItem('token')) {
          window.location.href = '/login.html';
          return;
        }

        // 1. NASCONDI TUTTO
        document.getElementById('stats').style.display = 'none';
        document.getElementById('map-and-list-container').style.display = 'none';
        document.getElementById('reportistica-section').style.display = 'none';
        document.getElementById('mappa-perizie-section').style.display = 'none'; // Add this line!

        // Nasconde anche la sezione dettagli cliente se visibile
        const dettagliSection = document.getElementById('dettagli-cliente-section');
        if (dettagliSection) {
          dettagliSection.style.display = 'none';
        }

        // 2. MOSTRA SOLO LA SEZIONE CLIENTI
        const clientiSection = document.getElementById('clienti-section');
        clientiSection.style.display = 'block';

        // 3. CARICA I DATI CLIENTI
        if (clientiData.length === 0) {
          caricaClienti();
        }

        // 4. EVIDENZIA IL LINK ATTIVO NELLA NAVBAR
        const navLinks = document.querySelectorAll('nav a');
        navLinks.forEach(link => {
          link.classList.remove('border-blue-500', 'text-gray-900');
          link.classList.add('border-transparent', 'text-gray-500');
        });
        this.classList.remove('border-transparent', 'text-gray-500');
        this.classList.add('border-blue-500', 'text-gray-900');
      });
    }

    // Aggiungi anche un event listener per tornare alla dashboard
    document.getElementById('clienti-section').style.display = 'none';

    // 2. MOSTRA LA DASHBOARD
    document.getElementById('stats').style.display = 'block';
    document.getElementById('map-and-list-container').style.display = 'grid';

    // 3. EVIDENZIA IL LINK ATTIVO NELLA NAVBAR
    const navLinks = document.querySelectorAll('nav a');
    navLinks.forEach(link => {
      link.classList.remove('border-blue-500', 'text-gray-900');
      link.classList.add('border-transparent', 'text-gray-500');
    });
    this.classList.remove('border-transparent', 'text-gray-500');
    this.classList.add('border-blue-500', 'text-gray-900');
  });

  // Funzione per mostrare la sezione corretta
  function mostraSezione(sezione) {
    // Nascondi tutte le sezioni
    document.getElementById('stats').classList.add('hidden');
    document.getElementById('map-and-list-container').classList.add('hidden');
    document.getElementById('clienti-section').classList.add('hidden');

    // Mostra la sezione richiesta
    if (sezione === 'dashboard') {
      document.getElementById('stats').classList.remove('hidden');
      document.getElementById('map-and-list-container').classList.remove('hidden');

      // Aggiorna la classe attiva nella navbar
      document.querySelector('a.border-blue-500').classList.remove('border-transparent', 'text-gray-500');
      document.querySelector('a.border-blue-500').classList.add('border-blue-500', 'text-gray-900');
      document.getElementById('menuClienti').classList.remove('border-blue-500', 'text-gray-900');
      document.getElementById('menuClienti').classList.add('border-transparent', 'text-gray-500');
    } else if (sezione === 'clienti') {
      document.getElementById('clienti-section').classList.remove('hidden');

      // Aggiorna la classe attiva nella navbar
      document.querySelector('a.border-blue-500').classList.remove('border-blue-500', 'text-gray-900');
      document.querySelector('a.border-blue-500').classList.add('border-transparent', 'text-gray-500');
      document.getElementById('menuClienti').classList.remove('border-transparent', 'text-gray-500');
      document.getElementById('menuClienti').classList.add('border-blue-500', 'text-gray-900');
    }

    sezioneCorrente = sezione;
  }

  // Funzione per caricare i dati dei clienti dalle perizie
  async function caricaClienti() {
    try {
      if (perizieData.length === 0) {
        await caricaPerizie();
      }

      // Estrai i clienti unici dalle perizie
      const clientiMap = {};

      perizieData.forEach(perizia => {
        const nomeCliente = perizia.cliente || 'Cliente non specificato';

        if (!clientiMap[nomeCliente]) {
          clientiMap[nomeCliente] = {
            nome: nomeCliente,
            perizie: [],
            totali: 0,
            completate: 0,
            inCorso: 0,
            inAttesa: 0
          };
        }

        clientiMap[nomeCliente].perizie.push(perizia);
        clientiMap[nomeCliente].totali++;

        if (perizia.stato === 'Completata') {
          clientiMap[nomeCliente].completate++;
        } else if (perizia.stato === 'In corso') {
          clientiMap[nomeCliente].inCorso++;
        } else {
          clientiMap[nomeCliente].inAttesa++;
        }
      });

      // Converti l'oggetto in array per la visualizzazione
      clientiData = Object.values(clientiMap);

      // Aggiorna le statistiche
      document.getElementById('clientiTotali').textContent = clientiData.length;
      document.getElementById('clientiCompletati').textContent = clientiData.filter(c => c.completate > 0).length;
      document.getElementById('clientiInCorso').textContent = clientiData.filter(c => c.inCorso > 0).length;

      // Aggiorna la tabella clienti
      const clientiList = document.getElementById('clientiList');

      if (clientiData.length === 0) {
        clientiList.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                Nessun cliente trovato.
              </td>
            </tr>
          `;
        return;
      }

      clientiList.innerHTML = '';

      clientiData.forEach(cliente => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-blue-600"></i>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">${cliente.nome}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.totali}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                ${cliente.completate}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                ${cliente.inCorso}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <button class="text-blue-600 hover:text-blue-900 mr-2" onclick="mostraDettagliCliente('${cliente.nome}')">
                <i class="fas fa-eye mr-1"></i> Dettagli
              </button>
        
            </td>
          `;
        clientiList.appendChild(row);
      });

    } catch (err) {
      console.error("Errore nel caricamento dei clienti:", err);
      document.getElementById('clientiList').innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-red-500">
              Errore nel caricamento dei clienti. Riprova più tardi.
            </td>
          </tr>
        `;
    }
  }

  // Funzione per mostrare i dettagli di un cliente
  function mostraDettagliCliente(nomeCliente) {
    // Trova il cliente selezionato
    const cliente = clientiData.find(c => c.nome === nomeCliente);
    if (!cliente) {
      alert('Cliente non trovato');
      return;
    }

    // Popola il contenuto del modal
    document.getElementById('cliente-modal-title').innerHTML = `
        ${cliente.nome}
        <div class="flex">
          <button class="ml-4 text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 rounded-full p-1" onclick="modificaCliente('${cliente.nome}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="ml-2 text-red-600 hover:text-red-800 bg-red-100 hover:bg-red-200 rounded-full p-1" onclick="eliminaCliente('${cliente.nome}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;

    const modalContent = document.getElementById('cliente-modal-content');
    modalContent.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm space-y-6">
          <!-- Info principali -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-blue-50 rounded-lg p-4 text-center">
              <p class="text-sm font-medium text-blue-600">Perizie Totali</p>
              <p class="text-2xl font-bold text-blue-800">${cliente.totali}</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
              <p class="text-sm font-medium text-green-600">Completate</p>
              <p class="text-2xl font-bold text-green-800">${cliente.completate}</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
              <p class="text-sm font-medium text-yellow-600">In Corso/Attesa</p>
              <p class="text-2xl font-bold text-yellow-800">${cliente.inCorso + cliente.inAttesa}</p>
            </div>
          </div>
          
          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-semibold text-gray-800">Analisi Cliente</h3>
            <p class="text-gray-600 mt-2">
              ${cliente.nome} ha un totale di ${cliente.totali} perizie, di cui ${cliente.completate} completate.
              ${cliente.inCorso > 0 ? `Ci sono ${cliente.inCorso} perizie in corso.` : ''}
              ${cliente.inAttesa > 0 ? `Ci sono ${cliente.inAttesa} perizie in attesa.` : ''}
            </p>
          </div>
        </div>
      `;

    // Popola la tabella delle perizie del cliente
    const clientePerizieBody = document.getElementById('cliente-perizie-body');
    clientePerizieBody.innerHTML = '';

    cliente.perizie.forEach(perizia => {
      const dataFormattata = new Date(perizia.createdAt).toLocaleDateString('it-IT');

      const statoClass =
        perizia.stato === 'Completata' ? 'bg-green-100 text-green-800' :
          perizia.stato === 'In corso' ? 'bg-blue-100 text-blue-800' :
            'bg-yellow-100 text-yellow-800';

      const row = document.createElement('tr');
      row.innerHTML = `
          <td class="px-4 py-2 text-sm text-gray-900">${perizia._id.substring(0, 8)}...</td>
          <td class="px-4 py-2 text-sm text-gray-500">${perizia.descrizione}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoClass}">
              ${perizia.stato}
            </span>
          </td>
          <td class="px-4 py-2 text-sm text-gray-500">${perizia.operatore || 'N/D'}</td>
          <td class="px-4 py-2 text-sm text-gray-500">${dataFormattata}</td>
          <td class="px-4 py-2 text-sm text-gray-500">
            <button class="text-blue-600 hover:text-blue-900" onclick="mostraDettagliPeriziaConChiusura('${perizia._id}')">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
      clientePerizieBody.appendChild(row);
    });

    // Mostra il modal
    const modal = document.getElementById('clienteModal');
    modal.style.display = 'flex';

    // Applica l'animazione di apertura
    setTimeout(() => {
      modal.querySelector('.modal-content').style.transform = 'scale(1)';
    }, 10);
  }

  // Gestore per il click su "Clienti"
  document.getElementById('menuClienti').addEventListener('click', function (e) {
    e.preventDefault();

    // Nascondi tutti gli elementi principali
    document.getElementById('stats').classList.add('hidden');
    document.getElementById('map-and-list-container').classList.add('hidden');

    // Se esiste una sezione perizie, nascondila
    if (document.getElementById('perizie-section')) {
      document.getElementById('perizie-section').classList.add('hidden');
    }

    // Se esiste già una sezione clienti, mostrala, altrimenti creala
    let clientiSection = document.getElementById('clienti-section');
    if (!clientiSection) {
      clientiSection = document.createElement('div');
      clientiSection.id = 'clienti-section';
      clientiSection.className = 'mt-6 bg-white rounded-lg shadow-md overflow-hidden';
      document.querySelector('main').appendChild(clientiSection);
    } else {
      clientiSection.classList.remove('hidden');
    }

    // Carica i dati dei clienti
    caricaListaClienti();

    // Aggiorna la classe attiva nella navbar
    const navLinks = document.querySelectorAll('nav a');
    navLinks.forEach(link => {
      link.classList.remove('border-blue-500', 'text-gray-900');
      link.classList.add('border-transparent', 'text-gray-500');
    });
    document.getElementById('menuClienti').classList.remove('border-transparent', 'text-gray-500');
    document.getElementById('menuClienti').classList.add('border-blue-500', 'text-gray-900');
  });

  // Function to show client details modal after closing any other open modals
  function mostraDettagliPeriziaConChiusura(nomeCliente) {
    // First, close any open modals
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });

    // Then show client details
    mostraDettagliCliente(nomeCliente);
  }


  // Function to show client details and related perizie
  function mostraDettagliCliente(nomeCliente) {
    // Find the client in the data
    const cliente = clientiData.find(c => c.nome === nomeCliente);
    if (!cliente) {
      alert('Cliente non trovato');
      return;
    }

    // Populate the modal header with client name
    document.getElementById('cliente-modal-title').textContent = cliente.nome;

    // Populate client details section with stats
    const contenuto = `
    <div class="bg-white p-6 rounded-xl shadow space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="flex items-center space-x-3">
          <div class="p-3 bg-blue-100 rounded-full">
            <i class="fas fa-clipboard-list text-blue-600 text-lg"></i>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Perizie Totali</p>
            <p class="text-xl text-gray-900 font-semibold">${cliente.totali}</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="p-3 bg-green-100 rounded-full">
            <i class="fas fa-check-circle text-green-600 text-lg"></i>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Completate</p>
            <p class="text-xl text-gray-900 font-semibold">${cliente.completate}</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="p-3 bg-yellow-100 rounded-full">
            <i class="fas fa-clock text-yellow-600 text-lg"></i>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">In Corso</p>
            <p class="text-xl text-gray-900 font-semibold">${cliente.inCorso}</p>
          </div>
        </div>
      </div>
    </div>
  `;

    document.getElementById('cliente-modal-content').innerHTML = contenuto;

    // Populate the perizie list related to this client
    const perizieList = document.getElementById('cliente-perizie-body');
    perizieList.innerHTML = '';

    if (cliente.perizie && cliente.perizie.length > 0) {
      cliente.perizie.forEach(perizia => {
        const row = document.createElement('tr');
        const data = new Date(perizia.createdAt).toLocaleDateString('it-IT');

        row.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-900">${perizia._id.substring(0, 8)}...</td>
        <td class="px-4 py-2 text-sm text-gray-500">${perizia.descrizione}</td>
        <td class="px-4 py-2 text-sm">
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
            ${perizia.stato === 'Completata' ? 'bg-green-100 text-green-800' :
            perizia.stato === 'In corso' ? 'bg-blue-100 text-blue-800' :
              'bg-yellow-100 text-yellow-800'}">
            ${perizia.stato}
          </span>
        </td>
        <td class="px-4 py-2 text-sm text-gray-500">${perizia.operatore || 'N/D'}</td>
        <td class="px-4 py-2 text-sm text-gray-500">${data}</td>
        <td class="px-4 py-2 text-sm text-gray-500">
          <button class="text-blue-600 hover:text-blue-900" onclick="mostraDettagliPerizia('${perizia._id}'); chiudiModal('clienteModal');">
            <i class="fas fa-eye"></i>
          </button>
        </td>
      `;

        perizieList.appendChild(row);
      });
    } else {
      perizieList.innerHTML = `
      <tr>
        <td colspan="6" class="px-4 py-6 text-center text-gray-500">
          Nessuna perizia trovata per questo cliente.
        </td>
      </tr>
    `;
    }

    // Show the modal
    document.getElementById('clienteModal').style.display = 'flex';

    // Apply the animation of opening
    setTimeout(() => {
      document.getElementById('clienteModal').querySelector('.modal-content').style.transform = 'scale(1)';
    }, 10);
  }

  // Funzione per caricare e visualizzare la lista clienti
  async function caricaListaClienti() {
    const clientiSection = document.getElementById('clienti-section');

    // Mostra un indicatore di caricamento
    clientiSection.innerHTML = `
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-users mr-2 text-blue-500"></i>
            Lista Clienti
          </h2>
        </div>
        <div class="p-6 text-center text-gray-500">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p class="mt-2">Caricamento dati clienti...</p>
        </div>
      `;

    try {
      // Estrai i clienti dalle perizie esistenti
      const clienti = estraiClientiDaPerizie();

      // Crea tabella clienti
      let contenutoHTML = `
          <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-users mr-2 text-blue-500"></i>
              Lista Clienti
            </h2>
          </div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Cliente
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Perizie Totali
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Completate
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      In Corso
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

      if (clienti.length === 0) {
        contenutoHTML += `
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                Nessun cliente trovato.
              </td>
            </tr>
          `;
      } else {
        clienti.forEach(cliente => {
          contenutoHTML += `
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                      <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">${cliente.nome}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.totali}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    ${cliente.completate}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${cliente.inCorso}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <button class="text-blue-600 hover:text-blue-900" onclick="mostraPerizieCliente('${cliente.nome}')">
                    <i class="fas fa-eye mr-1"></i> Dettagli
                  </button>
                </td>
              </tr>
            `;
        });
      }

      contenutoHTML += `
                </tbody>
              </table>
            </div>
          </div>
        `;

      clientiSection.innerHTML = contenutoHTML;
    } catch (err) {
      console.error("Errore nel caricamento dei clienti:", err);
      clientiSection.innerHTML = `
          <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-users mr-2 text-blue-500"></i>
              Lista Clienti
            </h2>
          </div>
          <div class="p-6 text-center text-red-500">
            <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
            <p>Si è verificato un errore nel caricamento dei clienti.</p>
          </div>
        `;
    }
  }
  let streetLayerDark, satelliteLayerDark, terrainLayerDark;
  let streetLayerDarkFullscreen, satelliteLayerDarkFullscreen, terrainLayerDarkFullscreen;

  // Function to initialize dark map layers
  function initDarkMapLayers() {
    // Dashboard map dark layers
    streetLayerDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });

    satelliteLayerDark = L.layerGroup([
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Imagery &copy; Esri'
      }),
      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19,
        opacity: 0.7
      })
    ]);

    terrainLayerDark = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-dark/{z}/{x}/{y}{r}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      subdomains: 'abcd',
      maxZoom: 18
    });

    // Fullscreen map dark layers
    streetLayerDarkFullscreen = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });

    satelliteLayerDarkFullscreen = L.layerGroup([
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Imagery &copy; Esri'
      }),
      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19,
        opacity: 0.7
      })
    ]);

    terrainLayerDarkFullscreen = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-dark/{z}/{x}/{y}{r}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      subdomains: 'abcd',
      maxZoom: 18
    });
  }

  // Function to update maps based on dark mode status
  function updateMapTheme(isDarkMode) {
    // Initialize dark layers if they don't exist yet
    if (!streetLayerDark) {
      initDarkMapLayers();
    }

    // Update dashboard map
    if (map) {
      // Get current layer type
      let activeLayerType = 'street';
      const layerSelector = document.getElementById('mapLayerSelector');
      if (layerSelector) {
        activeLayerType = layerSelector.value;
      }

      // Remove current layer
      map.removeLayer(currentLayer);

      // Set appropriate layer based on dark mode and layer type
      if (isDarkMode) {
        switch (activeLayerType) {
          case 'satellite':
            currentLayer = satelliteLayerDark;
            break;
          case 'terrain':
            currentLayer = terrainLayerDark;
            break;
          default:
            currentLayer = streetLayerDark;
        }
      } else {
        switch (activeLayerType) {
          case 'satellite':
            currentLayer = satelliteLayer;
            break;
          case 'terrain':
            currentLayer = terrainLayer;
            break;
          default:
            currentLayer = streetLayer;
        }
      }

      // Add new layer to map
      currentLayer.addTo(map);
    }

    // Update fullscreen map if it exists
    if (mapFullscreen) {
      // Get current layer type
      let activeLayerTypeFullscreen = 'street';
      const layerSelectorFullscreen = document.getElementById('mapLayerSelectorFullscreen');
      if (layerSelectorFullscreen) {
        activeLayerTypeFullscreen = layerSelectorFullscreen.value;
      }

      // Remove current layer
      mapFullscreen.removeLayer(currentLayerFullscreen);

      // Set appropriate layer based on dark mode and layer type
      if (isDarkMode) {
        switch (activeLayerTypeFullscreen) {
          case 'satellite':
            currentLayerFullscreen = satelliteLayerDarkFullscreen;
            break;
          case 'terrain':
            currentLayerFullscreen = terrainLayerDarkFullscreen;
            break;
          default:
            currentLayerFullscreen = streetLayerDarkFullscreen;
        }
      } else {
        switch (activeLayerTypeFullscreen) {
          case 'satellite':
            currentLayerFullscreen = satelliteLayerFullscreen;
            break;
          case 'terrain':
            currentLayerFullscreen = terrainLayerFullscreen;
            break;
          default:
            currentLayerFullscreen = streetLayerFullscreen;
        }
      }

      // Add new layer to map
      currentLayerFullscreen.addTo(mapFullscreen);
    }

    // Also update the geography chart map if it exists
    const chartGeoContainer = document.getElementById('chart-geography');
    if (chartGeoContainer && chartGeoContainer.querySelector('canvas')) {
      // Force redraw with current theme
      createGeographyChart();
    }
  }


  // Sostituisci il gestore dell'evento per il pulsante "Aggiungi immagine"
  document.addEventListener('DOMContentLoaded', function () {
    const aggiungiImmagineBtn = document.getElementById('aggiungiImmagine');

    if (aggiungiImmagineBtn) {
      aggiungiImmagineBtn.addEventListener('click', function () {
        const immaginiContainer = document.getElementById('immagini-container');

        // Clona il primo elemento immagine-gruppo
        const primoGruppo = immaginiContainer.querySelector('.immagine-gruppo');
        const nuovoGruppo = primoGruppo.cloneNode(true);

        // Reset dei valori
        const fileInput = nuovoGruppo.querySelector('.immagine-file');
        const commentoInput = nuovoGruppo.querySelector('.immagine-commento');
        const previewContainer = nuovoGruppo.querySelector('.img-preview').parentElement;

        fileInput.value = '';
        commentoInput.value = '';
        previewContainer.classList.add('hidden');

        // Aggiungi l'event listener per la preview anche al nuovo gruppo
        fileInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const preview = this.parentElement.querySelector('.img-preview');
              preview.src = e.target.result;
              preview.parentElement.classList.remove('hidden');
            }.bind(this);
            reader.readAsDataURL(file);
          }
        });

        // Aggiungi un pulsante di rimozione
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'mt-2 text-red-600 hover:text-red-800 text-sm';
        removeBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> Rimuovi';
        removeBtn.addEventListener('click', function () {
          nuovoGruppo.remove();
        });

        nuovoGruppo.appendChild(removeBtn);

        // Aggiungi il nuovo gruppo al container
        immaginiContainer.appendChild(nuovoGruppo);
      });
    }

    // Aggiungi l'event listener per la preview al primo gruppo di default
    const fileInputs = document.querySelectorAll('.immagine-file');
    fileInputs.forEach(input => {
      input.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = this.parentElement.querySelector('.img-preview');
            preview.src = e.target.result;
            preview.parentElement.classList.remove('hidden');
          }.bind(this);
          reader.readAsDataURL(file);
        }
      });
    });
  });
  // Modify the theme toggle button to also update maps
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    if (themeToggleBtn) {
      // Clone to remove existing listeners
      const newBtn = themeToggleBtn.cloneNode(true);
      themeToggleBtn.parentNode.replaceChild(newBtn, themeToggleBtn);

      // Add our enhanced listener
      newBtn.addEventListener('click', function () {
        document.body.classList.toggle('dark');
        const icon = this.querySelector('i');
        const isDarkMode = document.body.classList.contains('dark');

        if (isDarkMode) {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }

        // Save preference
        localStorage.setItem('darkMode', isDarkMode);

        // Update maps with correct theme
        updateMapTheme(isDarkMode);
      });

      // Also update map layer selectors to refresh theme when changed
      const mapLayerSelector = document.getElementById('mapLayerSelector');
      if (mapLayerSelector) {
        mapLayerSelector.addEventListener('change', function () {
          updateMapTheme(document.body.classList.contains('dark'));
        });
      }

      const mapLayerSelectorFullscreen = document.getElementById('mapLayerSelectorFullscreen');
      if (mapLayerSelectorFullscreen) {
        mapLayerSelectorFullscreen.addEventListener('change', function () {
          updateMapTheme(document.body.classList.contains('dark'));
        });
      }
    }

    // Initialize with correct theme on page load
    const darkMode = localStorage.getItem('darkMode') === 'true' ||
      (localStorage.getItem('darkMode') === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);

    if (darkMode) {
      // Initialize and apply dark theme to maps with a slight delay
      // to ensure maps are initialized
      setTimeout(() => {
        initDarkMapLayers();
        updateMapTheme(true);
      }, 500);
    }
  });


  // Aggiungi questo codice nella tua sezione script
  // Modifica l'event listener del form di nuova perizia
  document.getElementById('nuovaPeriziaForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Elaborazione...';

    try {
      // Ottieni l'indirizzo e fai il geocoding
      const indirizzo = document.getElementById('indirizzo').value;
      let coordinate;
      try {
        coordinate = await geocodeIndirizzo(indirizzo);
      } catch (error) {
        console.error("Errore geocoding:", error);
        alert("Impossibile trovare le coordinate per l'indirizzo specificato. Inserire un indirizzo valido.");
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
      }

      // Popola i campi nascosti con le coordinate
      document.getElementById('latitudine').value = coordinate.lat;
      document.getElementById('longitudine').value = coordinate.lng;

      const formData = new FormData();

      // Raccogli i dati generali della perizia
      formData.append('descrizione', document.getElementById('descrizione').value);
      formData.append('cliente', document.getElementById('cliente').value);
      formData.append('stato', document.getElementById('stato').value);
      formData.append('indirizzo', indirizzo);
      formData.append('coordinate', JSON.stringify([coordinate.lat, coordinate.lng]));

      // Se è admin, usa l'operatore selezionato, altrimenti usa l'username corrente
      const operatoreSelect = document.getElementById('operatore');
      if (userRole === 'admin' && operatoreSelect && operatoreSelect.value) {
        formData.append('operatore', operatoreSelect.value);
      }

      // Raccogli le immagini e i commenti
      const immaginiGruppi = document.querySelectorAll('.immagine-gruppo');

      immaginiGruppi.forEach((gruppo) => {
        const fileInput = gruppo.querySelector('.immagine-file');
        const commento = gruppo.querySelector('.immagine-commento').value;

        if (fileInput.files.length > 0) {
          formData.append('immagini', fileInput.files[0]);
          formData.append('commenti', commento);
        }
      });

      // Invia i dati al server
      const response = await fetch('/api/perizie', {
        method: 'POST',
        body: formData,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const responseData = await response.json();

        // Chiudi il modal
        chiudiModal('nuovaPeriziaModal');

        // Ricarica le perizie
        await caricaPerizie();

        // Se la mappa è inizializzata, centra sulle nuove coordinate
        if (map) {
          map.setView([coordinate.lat, coordinate.lng], 15);

          // Aggiorna i marker sulla mappa
          addPerizieMarkers();
        }

        alert('Perizia creata con successo!');
      } else {
        const errorData = await response.text();
        throw new Error(errorData);
      }
    } catch (err) {
      console.error('Errore:', err);
      alert('Errore: ' + (err.message || 'Si è verificato un problema durante la creazione della perizia'));
    } finally {
      // Ripristina il pulsante
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });

  // Funzione per geocoding indirizzo
  async function geocodeIndirizzo(indirizzo) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(indirizzo)}`);
      const data = await response.json();

      if (data && data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon)
        };
      } else {
        throw new Error('Indirizzo non trovato');
      }
    } catch (error) {
      console.error('Errore nel geocoding:', error);
      throw error;
    }
  }

  // Funzione per estrarre i clienti dalle perizie esistenti
  function estraiClientiDaPerizie() {
    // Crea una mappa per raccogliere i dati aggregati dei clienti
    const clientiMap = {};

    perizieData.forEach(perizia => {
      const nomeCliente = perizia.cliente || 'Cliente non specificato';

      if (!clientiMap[nomeCliente]) {
        clientiMap[nomeCliente] = {
          nome: nomeCliente,
          totali: 0,
          completate: 0,
          inCorso: 0,
          inAttesa: 0,
          perizie: []
        };
      }

      clientiMap[nomeCliente].perizie.push(perizia);
      clientiMap[nomeCliente].totali++;

      if (perizia.stato === 'Completata') {
        clientiMap[nomeCliente].completate++;
      } else if (perizia.stato === 'In corso') {
        clientiMap[nomeCliente].inCorso++;
      } else {
        clientiMap[nomeCliente].inAttesa++;
      }
    });

    // Converti la mappa in array e ordina per nome cliente
    return Object.values(clientiMap).sort((a, b) => a.nome.localeCompare(b.nome));
  }

  // Funzione per mostrare le perizie di un cliente specifico
  function mostraPerizieCliente(nomeCliente) {
    // Nascondi la lista clienti
    document.getElementById('clienti-section').style.display = 'none';

    // Estrai le perizie del cliente
    const perizie = perizieData.filter(p => p.cliente === nomeCliente);

    // Crea una sezione per visualizzare le perizie del cliente
    let dettagliClienteSection = document.getElementById('dettagli-cliente-section');
    if (!dettagliClienteSection) {
      dettagliClienteSection = document.createElement('div');
      dettagliClienteSection.id = 'dettagli-cliente-section';
      document.querySelector('main').appendChild(dettagliClienteSection);
    }

    dettagliClienteSection.className = 'mt-6 bg-white rounded-lg shadow-md overflow-hidden';

    // Crea il contenuto HTML per i dettagli del cliente
    let html = `
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-user mr-2 text-blue-500"></i>
            Cliente: ${nomeCliente}
          </h2>
          <button onclick="tornaAListaClienti()" class="text-blue-600 hover:text-blue-900 flex items-center">
            <i class="fas fa-arrow-left mr-1"></i> Torna alla lista clienti
          </button>
        </div>
        
        <div class="p-6">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    ID
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Descrizione
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Stato
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Operatore
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
      `;

    if (perizie.length === 0) {
      html += `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
              Nessuna perizia trovata per questo cliente.
            </td>
          </tr>
        `;
    } else {
      perizie.forEach(perizia => {
        const statoClass =
          perizia.stato === 'Completata' ? 'bg-green-100 text-green-800' :
            perizia.stato === 'In corso' ? 'bg-blue-100 text-blue-800' :
              'bg-yellow-100 text-yellow-800';

        html += `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${perizia._id.substring(0, 8)}...
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${perizia.descrizione}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoClass}">
                  ${perizia.stato}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${perizia.operatore || 'N/D'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button class="text-blue-600 hover:text-blue-900" onclick="mostraDettagliPerizia('${perizia._id}')">
                  <i class="fas fa-eye"></i> Dettagli
                </button>
              </td>
            </tr>
          `;
      });
    }

    html += `
              </tbody>
            </table>
          </div>
        </div>
      `;

    dettagliClienteSection.innerHTML = html;
    dettagliClienteSection.style.display = 'block';
  }

  // Funzione per tornare alla lista clienti
  // Funzione per tornare alla lista clienti
  function tornaAListaClienti() {
    document.getElementById('dettagli-cliente-section').style.display = 'none';
    document.getElementById('clienti-section').style.display = 'block';
  }

  // Aggiungi questo nella sezione script già esistente

  // Event listener per il click su "Reportistica"
  document.addEventListener('DOMContentLoaded', function () {
    // Link Dashboard
    document.querySelector('a.border-blue-500').addEventListener('click', function (e) {
      e.preventDefault();

      // Hide ALL sections
      const sections = [
        'clienti-section',
        'mappa-perizie-section',
        'reportistica-section',
        'dettagli-cliente-section'
      ];

      sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) section.style.display = 'none';
      });

      // Show dashboard sections
      document.getElementById('stats').style.display = 'block';
      document.getElementById('map-and-list-container').style.display = 'grid';

      // Update active navigation
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(link => {
        link.classList.remove('border-blue-500', 'text-gray-900');
        link.classList.add('border-transparent', 'text-gray-500');
      });
      this.classList.remove('border-transparent', 'text-gray-500');
      this.classList.add('border-blue-500', 'text-gray-900');
    });

    // Link Clienti (già esistente)
    // ...

    // Link Reportistica (nuovo)
    document.getElementById('menuReportistica').addEventListener('click', function (e) {
      e.preventDefault();

      // Verifica permessi admin
      if (userRole !== 'admin') {
        alert('Solo gli amministratori possono accedere alla reportistica');
        return;
      }

      // 1. NASCONDI TUTTO
      document.getElementById('stats').style.display = 'none';
      document.getElementById('map-and-list-container').style.display = 'none';
      document.getElementById('clienti-section').style.display = 'none';

      // 2. MOSTRA SOLO LA SEZIONE REPORTISTICA
      // Importante: usa style.display invece di classList
      const reportisticaSection = document.getElementById('reportistica-section');
      reportisticaSection.style.display = 'block'; // Usa style.display invece di classList

      // 3. CARICA I DATI REPORTISTICA
      caricaReportistica();

      // 4. EVIDENZIA IL LINK ATTIVO NELLA NAVBAR
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(link => {
        link.classList.remove('border-blue-500', 'text-gray-900');
        link.classList.add('border-transparent', 'text-gray-500');
      });
      this.classList.remove('border-transparent', 'text-gray-500');
      this.classList.add('border-blue-500', 'text-gray-900');
    });

    // Link Perizie (nuovo)
    document.getElementById('menuPerizie').addEventListener('click', function (e) {
      e.preventDefault();

      // Hide ALL sections
      document.getElementById('stats').style.display = 'none';
      document.getElementById('map-and-list-container').style.display = 'none';
      document.getElementById('clienti-section').style.display = 'none';
      document.getElementById('reportistica-section').style.display = 'none';

      // Hide any client detail section if visible
      const dettagliSection = document.getElementById('dettagli-cliente-section');
      if (dettagliSection) {
        dettagliSection.style.display = 'none';
      }

      // Show full-screen map section
      document.getElementById('mappa-perizie-section').style.display = 'block';

      // Init or update map
      initFullscreenMap();

      // Update active navigation
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(link => {
        link.classList.remove('border-blue-500', 'text-gray-900');
        link.classList.add('border-transparent', 'text-gray-500');
      });
      this.classList.remove('border-transparent', 'text-gray-500');
      this.classList.add('border-blue-500', 'text-gray-900');
    });
  });

  // Variabili per la mappa full-screen
  let mapFullscreen = null;
  let markersFullscreen = [];
  let currentLayerFullscreen = null;

  // Funzione per inizializzare la mappa full-screen
  function initFullscreenMap() {
    // If map already exists, just update markers
    if (mapFullscreen) {
      mapFullscreen.invalidateSize();
      addPerizieMarkersFullscreen();
      return;
    }

    // Initialize the Leaflet map
    mapFullscreen = L.map('mapFullscreen', {
      worldCopyJump: true
    }).setView(SEDE_UFFICIO, 13);

    // Initialize map layers
    const streetLayerFullscreen = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      noWrap: true,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    });

    const satelliteLayerFullscreen = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      noWrap: true,
      attribution: 'Imagery &copy; Esri'
    });

    const terrainLayerFullscreen = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      noWrap: true,
      attribution: 'Imagery &copy; Esri &mdash; Esri, DeLorme, NAVTEQ'
    });

    // Set default layer
    currentLayerFullscreen = streetLayerFullscreen;
    currentLayerFullscreen.addTo(mapFullscreen);

    L.marker(SEDE_UFFICIO)
      .addTo(mapFullscreen)
      .bindPopup("<b>Sede Ufficio</b>")
      .openPopup();


    // Add legend for different types of markers
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.backgroundColor = 'white';
      div.style.padding = '6px';
      div.style.borderRadius = '4px';
      div.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';

      div.innerHTML = `
          <div style="margin-bottom:5px;font-weight:bold;font-size:12px;">Stato Perizie</div>
          <div><i style="background:#10b981;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> Completate</div>
          <div><i style="background:#3b82f6;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> In corso</div>
          <div><i style="background:#f59e0b;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> In attesa</div>
        `;

      return div;
    };
    legend.addTo(mapFullscreen);

    // Add perizie markers with clusters
    addPerizieMarkersFullscreen();

    // Handle layer changes
    document.getElementById('mapLayerSelectorFullscreen').addEventListener('change', function (e) {
      // Remove current layer
      mapFullscreen.removeLayer(currentLayerFullscreen);

      // Add the newly selected layer
      switch (e.target.value) {
        case 'satellite':
          currentLayerFullscreen = satelliteLayerFullscreen;
          break;
        case 'terrain':
          currentLayerFullscreen = terrainLayerFullscreen;
          break;
        default:
          currentLayerFullscreen = streetLayerFullscreen;
      }

      mapFullscreen.addLayer(currentLayerFullscreen);
    });

    // Only show and populate operator filter for admins
    const operatorFilterFullscreen = document.getElementById('operatorFilterFullscreen');
    if (userRole === 'admin') {
      operatorFilterFullscreen.style.display = 'block';

      // Populate the operator filter
      const operatori = [...new Set(perizieData.map(p => p.operatore).filter(Boolean))];
      operatorFilterFullscreen.innerHTML = '<option value="">Tutti gli operatori</option>';

      operatori.forEach(operatore => {
        const option = document.createElement('option');
        option.value = operatore;
        option.textContent = operatore;
        operatorFilterFullscreen.appendChild(option);
      });

      // Add event listener for the filter
      operatorFilterFullscreen.addEventListener('change', addPerizieMarkersFullscreen);
    } else {
      operatorFilterFullscreen.style.display = 'none';
    }
  }

  // Funzione per aggiungere i marker delle perizie alla mappa full-screen
  function addPerizieMarkersFullscreen() {
    // Clear existing markers
    if (markersFullscreen.length > 0) {
      if (markersFullscreen instanceof L.MarkerClusterGroup) {
        mapFullscreen.removeLayer(markersFullscreen);
      } else {
        markersFullscreen.forEach(marker => mapFullscreen.removeLayer(marker));
      }
    }

    // Create a new marker cluster group
    markersFullscreen = L.markerClusterGroup({
      disableClusteringAtZoom: 15,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: true,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 30
    });

    // Get perizie to display
    let perizieFiltrate = perizieData;

    // Apply different filtering based on user role
    if (userRole !== 'admin') {
      // Operators can only see their own perizie
      perizieFiltrate = perizieData.filter(p => p.operatore === username);
    } else {
      // Admin can filter by operator
      const operatorFilter = document.getElementById('operatorFilterFullscreen').value;
      if (operatorFilter) {
        perizieFiltrate = perizieData.filter(p => p.operatore === operatorFilter);
      }
    }

    // Icons for different states
    const iconaCompletata = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInCorso = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInAttesa = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Counters for zones
    const zoneCounter = {};

    // Add markers for each perizia
    perizieFiltrate.forEach(perizia => {
      if (perizia.coordinate && perizia.coordinate.length === 2) {
        // Choose icon based on state
        let icon;
        switch (perizia.stato) {
          case "Completata":
            icon = iconaCompletata;
            break;
          case "In corso":
            icon = iconaInCorso;
            break;
          default:
            icon = iconaInAttesa;
        }

        // Track zone statistics
        if (perizia.indirizzo) {
          const zona = perizia.indirizzo.split(',')[0].trim();
          zoneCounter[zona] = (zoneCounter[zona] || 0) + 1;
        }

        // Create marker with appropriate icon
        const marker = L.marker(perizia.coordinate, { icon: icon })
          .bindPopup(`
              <b>${perizia.descrizione}</b><br>
              Cliente: ${perizia.cliente || 'N/D'}<br>
              Stato: <span style="color:${perizia.stato === 'Completata' ? '#10b981' :
              perizia.stato === 'In corso' ? '#3b82f6' :
                '#f59e0b'}">${perizia.stato}</span><br>
              ${perizia.indirizzo ? `Indirizzo: ${perizia.indirizzo}<br>` : ''}
              <button onclick="mostraDettagliPerizia('${perizia._id}')" 
                      style="background:#3b82f6;color:white;border:none;padding:3px 8px;border-radius:4px;margin-top:5px;cursor:pointer">
                Dettagli
              </button>
            `);

        markersFullscreen.addLayer(marker);
      }
    });

    // Add the markers cluster to the map
    mapFullscreen.addLayer(markersFullscreen);

    // Fit map to show all markers
    if (markersFullscreen.getLayers().length > 0) {
      mapFullscreen.fitBounds(markersFullscreen.getBounds().pad(0.1));
    } else {
      mapFullscreen.setView(SEDE_UFFICIO, 10);
    }

    // Add top zones info box
    const topZones = Object.entries(zoneCounter)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    // Remove existing infobox if present
    const existingInfoBox = document.querySelector('.leaflet-control.topzones');
    if (existingInfoBox) {
      existingInfoBox.remove();
    }

    if (topZones.length > 0) {
      const infoBox = L.control({ position: 'bottomleft' });
      infoBox.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info topzones');
        div.style.backgroundColor = 'white';
        div.style.padding = '8px';
        div.style.borderRadius = '4px';
        div.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';
        div.style.maxWidth = '200px';

        let html = '<div style="font-weight:bold;margin-bottom:5px;">Top 5 Zone</div>';

        topZones.forEach(([zone, count]) => {
          const percentage = Math.round((count / perizieFiltrate.length) * 100);
          html += `<div style="margin:4px 0">
              <div style="display:flex;justify-content:space-between">
                <span>${zone}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div style="background:#e5e7eb;height:6px;border-radius:3px;margin-top:2px">
                <div style="background:#3b82f6;width:${percentage}%;height:6px;border-radius:3px"></div>
              </div>
            </div>`;
        });

        div.innerHTML = html;
        return div;
      };
      infoBox.addTo(mapFullscreen);
    }
  }

  // Add this function to initialize the map
  function initMap() {
    console.log("Initializing map...");

    // Initialize the map if it doesn't exist
    if (!map) {
      // Create map instance
      map = L.map('map', {
        worldCopyJump: true
      }).setView(SEDE_UFFICIO, 13);

      // Initialize map layers
      streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      });

      satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Imagery &copy; Esri'
      });

      terrainLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Imagery &copy; Esri &mdash; Esri, DeLorme, NAVTEQ'
      });

      // Add default layer to map
      currentLayer = streetLayer;
      currentLayer.addTo(map);

      L.marker(SEDE_UFFICIO)
        .addTo(map)
        .bindPopup("<b>Sede Ufficio</b>")
        .openPopup();

      // Set up layer selector
      document.getElementById('mapLayerSelector').addEventListener('change', function (e) {
        // Remove current layer
        map.removeLayer(currentLayer);

        // Add selected layer
        switch (e.target.value) {
          case 'satellite':
            currentLayer = satelliteLayer;
            break;
          case 'terrain':
            currentLayer = terrainLayer;
            break;
          default:
            currentLayer = streetLayer;
        }
        map.addLayer(currentLayer);
      });
    }

    // Add markers for perizie
    addPerizieMarkers();

    // Make sure map is properly displayed
    setTimeout(() => {
      if (map) {
        map.invalidateSize();
      }
    }, 100);
  }

  async function caricaReportistica() {
    try {
      // Ensure we have perizie data
      if (perizieData.length === 0) {
        await caricaPerizie();
      }

      // Update KPIs
      const completionRate = Math.round((perizieData.filter(p => p.stato === 'Completata').length / perizieData.length) * 100);
      document.getElementById('kpi-completion-rate').textContent = `${completionRate}%`;

      // Calculate average time (assuming createdAt and completedAt fields exist)
      let avgTimeInDays = 0;
      const completedPerizie = perizieData.filter(p => p.stato === 'Completata' && p.createdAt);
      if (completedPerizie.length > 0) {
        avgTimeInDays = Math.round(completedPerizie.reduce((sum, p) => {
          const startDate = new Date(p.createdAt);
          const endDate = p.completedAt ? new Date(p.completedAt) : new Date();
          return sum + (endDate - startDate) / (1000 * 60 * 60 * 24);
        }, 0) / completedPerizie.length);
      }
      document.getElementById('kpi-avg-time').textContent = `${avgTimeInDays} giorni`;

      // Find top zones (using first part of address as zone)
      const zones = {};
      perizieData.forEach(p => {
        if (p.indirizzo) {
          const zone = p.indirizzo.split(',')[0].trim();
          zones[zone] = (zones[zone] || 0) + 1;
        }
      });
      const topZones = Object.entries(zones).sort((a, b) => b[1] - a[1]);
      document.getElementById('kpi-top-zones').textContent = topZones.length > 0 ? topZones[0][0] : '--';

      // Find top operator
      const operators = {};
      perizieData.forEach(p => {
        if (p.operatore) {
          operators[p.operatore] = (operators[p.operatore] || 0) + 1;
        }
      });
      const topOperators = Object.entries(operators).sort((a, b) => b[1] - a[1]);
      document.getElementById('kpi-top-operator').textContent = topOperators.length > 0 ? topOperators[0][0] : '--';

      // Create charts
      createTrendChart();
      createStatusChart();
      createOperatorsChart();
      createGeographyChart();

    } catch (err) {
      console.error('Errore nel caricamento della reportistica:', err);
    }
  }

  // Chart creation functions
  function createTrendChart() {
    const chartContainer = document.getElementById('chart-trend');

    // Clear previous chart if it exists
    while (chartContainer.firstChild) {
      chartContainer.removeChild(chartContainer.firstChild);
    }

    // Create new canvas
    const canvas = document.createElement('canvas');
    chartContainer.appendChild(canvas);

    const ctx = canvas.getContext('2d');

    // Check for existing Chart instance in the global Chart registry
    Chart.helpers.each(Chart.instances, function (instance) {
      if (instance.canvas.parentNode === chartContainer) {
        instance.destroy();
      }
    });

    // Group perizie by month
    const months = {};
    perizieData.forEach(p => {
      if (p.createdAt) {
        const date = new Date(p.createdAt);
        const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
        if (!months[monthKey]) {
          months[monthKey] = { total: 0, completed: 0 };
        }
        months[monthKey].total++;
        if (p.stato === 'Completata') {
          months[monthKey].completed++;
        }
      }
    });

    // Sort months chronologically
    const sortedMonths = Object.entries(months).sort((a, b) => {
      return new Date(a[0] + '-01') - new Date(b[0] + '-01');
    });

    // Format labels for display
    const labels = sortedMonths.map(([key]) => {
      const [year, month] = key.split('-');
      return `${month}/${year}`;
    });

    // Create chart data
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Totale Perizie',
            data: sortedMonths.map(([_, data]) => data.total),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true
          },
          {
            label: 'Completate',
            data: sortedMonths.map(([_, data]) => data.completed),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  //add event listener for profile button
  document.addEventListener('DOMContentLoaded', function () {
    const profileButton = document.getElementById('profiloBtn');
    if (profileButton) {
      profileButton.addEventListener('click', function () {
        console.log("redirezione a profilo.html")
        window.location.href = 'profilo.html';
      })
    }

  });
  function createStatusChart() {
    const ctx = document.querySelector('#chart-status canvas').getContext('2d');

    // Count perizie by status
    const statusCounts = {
      'Completata': 0,
      'In corso': 0,
      'In attesa': 0
    };

    perizieData.forEach(p => {
      if (p.stato) {
        statusCounts[p.stato] = (statusCounts[p.stato] || 0) + 1;
      } else {
        statusCounts['In attesa']++;
      }
    });

    // Create chart
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: [
            'rgba(16, 185, 129, 0.7)',  // green for Completata
            'rgba(59, 130, 246, 0.7)',   // blue for In corso
            'rgba(245, 158, 11, 0.7)'    // yellow for In attesa
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  function createOperatorsChart() {
    const ctx = document.querySelector('#chart-operators canvas').getContext('2d');

    // Group perizie by operator
    const operators = {};
    perizieData.forEach(p => {
      if (p.operatore) {
        if (!operators[p.operatore]) {
          operators[p.operatore] = { total: 0, completed: 0 };
        }
        operators[p.operatore].total++;
        if (p.stato === 'Completata') {
          operators[p.operatore].completed++;
        }
      }
    });

    // Calculate completion rates
    const operatorData = Object.entries(operators).map(([name, data]) => {
      const completionRate = data.total > 0 ? (data.completed / data.total) * 100 : 0;
      return { name, total: data.total, completionRate };
    });

    // Sort by total perizie
    const sortedOperators = operatorData.sort((a, b) => b.total - a.total).slice(0, 8);

    // Create chart
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedOperators.map(o => o.name),
        datasets: [
          {
            label: 'Perizie Totali',
            data: sortedOperators.map(o => o.total),
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            order: 1
          },
          {
            label: 'Tasso di Completamento (%)',
            data: sortedOperators.map(o => o.completionRate),
            backgroundColor: 'rgba(16, 185, 129, 0.7)',
            type: 'line',
            yAxisID: 'y1',
            order: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Numero di Perizie'
            }
          },
          y1: {
            beginAtZero: true,
            position: 'right',
            max: 100,
            title: {
              display: true,
              text: 'Tasso di Completamento (%)'
            },
            grid: {
              drawOnChartArea: false
            }
          }
        }
      }
    });
  }

  // Aggiungi questa funzione dopo createOperatorsChart
  function createGeographyChart() {
    // Rimuovi il placeholder
    const container = document.getElementById('chart-geography');
    container.innerHTML = '';

    // Crea un elemento per la mappa
    const mapElement = document.createElement('div');
    mapElement.style.width = '100%';
    mapElement.style.height = '100%';
    container.appendChild(mapElement);

    // Inizializza la mappa
    const geoMap = L.map(mapElement).setView(SEDE_UFFICIO, 10);

    // Aggiungi il layer base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
      maxZoom: 19
    }).addTo(geoMap);

    // Prepara la legenda
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.backgroundColor = 'white';
      div.style.padding = '6px';
      div.style.borderRadius = '4px';
      div.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';

      div.innerHTML = `
          <div style="margin-bottom:5px;font-weight:bold;font-size:12px;">Stato Perizie</div>
          <div><i style="background:#10b981;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> Completate</div>
          <div><i style="background:#3b82f6;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> In corso</div>
          <div><i style="background:#f59e0b;width:10px;height:10px;display:inline-block;border-radius:50%;"></i> In attesa</div>
        `;

      return div;
    };
    legend.addTo(geoMap);

    // Prepara i cluster per raggruppare i marker
    const markers = L.markerClusterGroup({
      disableClusteringAtZoom: 15,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: true,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 30
    });

    // Icone per i diversi stati
    const iconaCompletata = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInCorso = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const iconaInAttesa = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Counters per le zone
    const zoneCounter = {};

    // Aggiungi i marker per le perizie con coordinate valide
    perizieData.forEach(perizia => {
      if (perizia.coordinate && perizia.coordinate.length === 2) {
        // Scegli l'icona in base allo stato
        let icon;
        switch (perizia.stato) {
          case "Completata":
            icon = iconaCompletata;
            break;
          case "In corso":
            icon = iconaInCorso;
            break;
          default:
            icon = iconaInAttesa;
        }

        // Aggiungi al conteggio per zona
        if (perizia.indirizzo) {
          const zona = perizia.indirizzo.split(',')[0].trim();
          zoneCounter[zona] = (zoneCounter[zona] || 0) + 1;
        }

        // Crea il marker
        const marker = L.marker(perizia.coordinate, { icon: icon })
          .bindPopup(`
              <b>${perizia.descrizione}</b><br>
              Cliente: ${perizia.cliente || 'N/D'}<br>
              Stato: <span style="color:${perizia.stato === 'Completata' ? '#10b981' :
              perizia.stato === 'In corso' ? '#3b82f6' :
                '#f59e0b'}">${perizia.stato}</span><br>
              ${perizia.indirizzo ? `Indirizzo: ${perizia.indirizzo}<br>` : ''}
              <button onclick="mostraDettagliPerizia('${perizia._id}')" 
                      style="background:#3b82f6;color:white;border:none;padding:3px 8px;border-radius:4px;margin-top:5px;cursor:pointer">
                Dettagli
              </button>
            `);

        markers.addLayer(marker);
      }
    });

    // Aggiungi tutti i markers alla mappa
    geoMap.addLayer(markers);

    // Adatta la vista per mostrare tutti i marker
    if (markers.getLayers().length > 0) {
      geoMap.fitBounds(markers.getBounds());
    } else {
      geoMap.setView(SEDE_UFFICIO, 10);
    }

    // Aggiungi un mini-grafico con le top 5 zone nel box info
    const topZones = Object.entries(zoneCounter)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    if (topZones.length > 0) {
      const infoBox = L.control({ position: 'bottomleft' });
      infoBox.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info topzones');
        div.style.backgroundColor = 'white';
        div.style.padding = '8px';
        div.style.borderRadius = '4px';
        div.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';
        div.style.maxWidth = '200px';

        let html = '<div style="font-weight:bold;margin-bottom:5px;">Top 5 Zone</div>';

        topZones.forEach(([zone, count]) => {
          const percentage = Math.round((count / perizieData.length) * 100);
          html += `<div style="margin:4px 0">
              <div style="display:flex;justify-content:space-between">
                <span>${zone}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div style="background:#e5e7eb;height:6px;border-radius:3px;margin-top:2px">
                <div style="background:#3b82f6;width:${percentage}%;height:6px;border-radius:3px"></div>
              </div>
            </div>`;
        });

        div.innerHTML = html;
        return div;
      };
      infoBox.addTo(geoMap);
    }

    // Invalidate size per assicurarsi che la mappa si disegni correttamente
    setTimeout(() => {
      geoMap.invalidateSize();
    }, 100);
  }

  // Report generation functions
  document.addEventListener('DOMContentLoaded', function () {
    // Add event listeners for report buttons
    const pdfButton = document.getElementById('btn-pdf');


    if (pdfButton) {
      pdfButton.addEventListener('click', generatePDFReport);
    }

  });

  // Generate PDF Report
  function generatePDFReport() {
    const reportType = document.getElementById('report-type').value;
    const reportPeriod = document.getElementById('report-period').value;

    // Show loading state
    const button = document.getElementById('btn-pdf');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generazione...';

    try {
      // Filter data based on period
      const filteredData = filterDataByPeriod(reportPeriod);

      // Create PDF document
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add header
      doc.setFontSize(18);
      doc.setTextColor(40, 40, 40);
      doc.text('Rilievi & Perizie - Report', 14, 22);

      // Add metadata
      doc.setFontSize(11);
      doc.setTextColor(100, 100, 100);
      doc.text(`Tipo Report: ${getReportTypeName(reportType)}`, 14, 30);
      doc.text(`Periodo: ${getReportPeriodName(reportPeriod)}`, 14, 36);
      doc.text(`Data Generazione: ${new Date().toLocaleDateString('it-IT')}`, 14, 42);

      // Add report content based on type
      switch (reportType) {
        case 'summary':
          generateSummaryReport(doc, filteredData);
          break;
        case 'operators':
          generateOperatorsReport(doc, filteredData);
          break;
        case 'clients':
          generateClientsReport(doc, filteredData);
          break;
        case 'geography':
          generateGeographyReport(doc, filteredData);
          break;
      }

      // Save the PDF
      doc.save(`Rilievi-Perizie-Report-${reportType}-${new Date().toISOString().split('T')[0]}.pdf`);

    } catch (err) {
      console.error('Errore nella generazione del report PDF:', err);
      alert('Errore nella generazione del report PDF.');
    } finally {
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }



  // Helper function to filter data by period
  function filterDataByPeriod(period) {
    // Start with all data
    let filteredData = [...perizieData];

    const now = new Date();
    switch (period) {
      case 'last30':
        // Last 30 days
        const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
        filteredData = filteredData.filter(p => new Date(p.createdAt) >= thirtyDaysAgo);
        break;
      case 'last90':
        // Last 90 days
        const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
        filteredData = filteredData.filter(p => new Date(p.createdAt) >= ninetyDaysAgo);
        break;
      case 'year':
        // Current year
        const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
        filteredData = filteredData.filter(p => new Date(p.createdAt) >= firstDayOfYear);
        break;
      case 'all':
      default:
        // All data (no filter)
        break;
    }

    return filteredData;
  }

  // Helper functions to get display names
  function getReportTypeName(type) {
    const types = {
      'summary': 'Riepilogo Generale',
      'operators': 'Performance Operatori',
      'clients': 'Analisi Clienti',
      'geography': 'Distribuzione Geografica'
    };
    return types[type] || 'Riepilogo Generale';
  }

  function getReportPeriodName(period) {
    const periods = {
      'last30': 'Ultimi 30 giorni',
      'last90': 'Ultimi 90 giorni',
      'year': 'Anno corrente',
      'all': 'Tutti i dati'
    };
    return periods[period] || 'Tutti i dati';
  }

  // PDF Report Generators
  function generateSummaryReport(doc, data) {
    // Add summary section
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text('Riepilogo Statistiche', 14, 55);

    // KPI Overview
    const completate = data.filter(p => p.stato === 'Completata').length;
    const inCorso = data.filter(p => p.stato === 'In corso').length;
    const inAttesa = data.filter(p => p.stato === 'In attesa').length;
    const total = data.length;
    const completionRate = total > 0 ? Math.round((completate / total) * 100) : 0;

    // Create table for basic stats
    doc.autoTable({
      startY: 60,
      head: [['Metriche', 'Valore']],
      body: [
        ['Perizie Totali', total],
        ['Completate', completate],
        ['In Corso', inCorso],
        ['In Attesa', inAttesa],
        ['Tasso di Completamento', `${completionRate}%`]
      ],
      theme: 'grid',
      headStyles: { fillColor: [59, 130, 246] }
    });

    // Clienti principali
    const clienti = {};
    data.forEach(p => {
      const cliente = p.cliente || 'Non specificato';
      if (!clienti[cliente]) clienti[cliente] = 0;
    });

    const topClienti = Object.entries(clienti)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    if (topClienti.length > 0) {
      doc.setFontSize(14);
      doc.text('Top 5 Clienti', 14, doc.autoTable.previous.finalY + 15);

      const clientiData = topClienti.map(([name, count]) => [name, count, `${Math.round(count / total * 100)}%`]);

      doc.autoTable({
        startY: doc.autoTable.previous.finalY + 20,
        head: [['Cliente', 'Perizie', 'Percentuale']],
        body: clientiData,
        theme: 'grid',
        headStyles: { fillColor: [16, 185, 129] }
      });
    }

    // Operatori principali
    const operatori = {};
    data.forEach(p => {
      const operatore = p.operatore || 'Non specificato';
      if (!operatori[operatore]) operatori[operatore] = { total: 0, completed: 0 };
      operatori[operatore].total++;
      if (p.stato === 'Completata') operatori[operatore].completed++;
    });

    const topOperatori = Object.entries(operatori)
      .sort((a, b) => b[1].total - a[1].total)
      .slice(0, 5);

    if (topOperatori.length > 0) {
      doc.setFontSize(14);
      doc.text('Top 5 Operatori', 14, doc.autoTable.previous.finalY + 15);

      const operatoriData = topOperatori.map(([name, { total, completed }]) => {
        const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
        return [name, total, completed, `${rate}%`];
      });

      doc.autoTable({
        startY: doc.autoTable.previous.finalY + 20,
        head: [['Operatore', 'Perizie Totali', 'Completate', 'Tasso Completamento']],
        body: operatoriData,
        theme: 'grid',
        headStyles: { fillColor: [245, 158, 11] }
      });
    }

    // Add footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text(`Pagina ${i} di ${pageCount} - Rilievi & Perizie - Report generato il ${new Date().toLocaleDateString('it-IT')}`,
        doc.internal.pageSize.getWidth() / 2,
        doc.internal.pageSize.getHeight() - 10,
        { align: 'center' }
      );
    }
  }

  function generateOperatorsReport(doc, data) {
    // Implementation for operators report
    doc.setFontSize(14);
    doc.text('Performance Operatori', 14, 55);

    // Group data by operator
    const operatori = {};
    data.forEach(p => {
      const operatore = p.operatore || 'Non specificato';
      if (!operatori[operatore]) {
        operatori[operatore] = {
          totali: 0,
          completate: 0,
          inCorso: 0,
          inAttesa: 0
        };
      }

      operatori[operatore].totali++;

      if (p.stato === 'Completata') operatori[operatore].completate++;
      else if (p.stato === 'In corso') operatori[operatore].inCorso++;
      else operatori[operatore].inAttesa++;
    });

    // Convert to array and sort
    const operatoriArray = Object.entries(operatori).map(([nome, stats]) => {
      const tassoCompletamento = stats.totali > 0 ? Math.round((stats.completate / stats.totali) * 100) : 0;
      return {
        nome,
        ...stats,
        tassoCompletamento
      };
    }).sort((a, b) => b.totali - a.totali);

    // Create table
    const tableData = operatoriArray.map(op => [
      op.nome,
      op.totali,
      op.completate,
      op.inCorso,
      op.inAttesa,
      `${op.tassoCompletamento}%`
    ]);

    doc.autoTable({
      startY: 60,
      head: [['Operatore', 'Totali', 'Completate', 'In Corso', 'In Attesa', 'Completamento']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: [59, 130, 246] }
    });

    // Add footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text(`Pagina ${i} di ${pageCount} - Rilievi & Perizie - Report generato il ${new Date().toLocaleDateString('it-IT')}`,
        doc.internal.pageSize.getWidth() / 2,
        doc.internal.pageSize.getHeight() - 10,
        { align: 'center' }
      );
    }
  }

  function generateClientsReport(doc, data) {
    // Implementation for clients report
    doc.setFontSize(14);
    doc.text('Analisi Clienti', 14, 55);

    // Group data by client
    const clienti = {};
    data.forEach(p => {
      const cliente = p.cliente || 'Non specificato';
      if (!clienti[cliente]) {
        clienti[cliente] = {
          totali: 0,
          completate: 0,
          inCorso: 0,
          inAttesa: 0
        };
      }

      clienti[cliente].totali++;

      if (p.stato === 'Completata') clienti[cliente].completate++;
      else if (p.stato === 'In corso') clienti[cliente].inCorso++;
      else clienti[cliente].inAttesa++;
    });

    // Convert to array and sort
    const clientiArray = Object.entries(clienti).map(([nome, stats]) => {
      const tassoCompletamento = stats.totali > 0 ? Math.round((stats.completate / stats.totali) * 100) : 0;
      return {
        nome,
        ...stats,
        tassoCompletamento
      };
    }).sort((a, b) => b.totali - a.totali);

    // Create table
    const tableData = clientiArray.map(c => [
      c.nome,
      c.totali,
      c.completate,
      c.inCorso,
      c.inAttesa,
      `${c.tassoCompletamento}%`
    ]);

    doc.autoTable({
      startY: 60,
      head: [['Cliente', 'Totali', 'Completate', 'In Corso', 'In Attesa', 'Completamento']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: [16, 185, 129] }
    });

    // Add footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text(`Pagina ${i} di ${pageCount} - Rilievi & Perizie - Report generato il ${new Date().toLocaleDateString('it-IT')}`,
        doc.internal.pageSize.getWidth() / 2,
        doc.internal.pageSize.getHeight() - 10,
        { align: 'center' }
      );
    }
  }

  function generateGeographyReport(doc, data) {
    // Implementation for geography report
    doc.setFontSize(14);
    doc.text('Distribuzione Geografica', 14, 55);

    // Group by zone (first part of address)
    const zone = {};
    data.forEach(p => {
      if (p.indirizzo) {
        const zona = p.indirizzo.split(',')[0].trim();
        if (!zone[zona]) {
          zone[zona] = {
            totali: 0,
            completate: 0,
            inCorso: 0,
            inAttesa: 0
          };
        }

        zone[zona].totali++;

        if (p.stato === 'Completata') zone[zona].completate++;
        else if (p.stato === 'In corso') zone[zona].inCorso++;
        else zone[zona].inAttesa++;
      }
    });

    // Convert to array and sort
    const zoneArray = Object.entries(zone).map(([nome, stats]) => {
      const percentuale = data.length > 0 ? Math.round((stats.totali / data.length) * 100) : 0;
      return {
        nome,
        ...stats,
        percentuale
      };
    }).sort((a, b) => b.totali - a.totali);

    // Create table
    const tableData = zoneArray.map(z => [
      z.nome,
      z.totali,
      z.completate,
      z.inCorso,
      z.inAttesa,
      `${z.percentuale}%`
    ]);

    doc.autoTable({
      startY: 60,
      head: [['Zona', 'Totali', 'Completate', 'In Corso', 'In Attesa', '% sul Totale']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: [139, 92, 246] }
    });

    // Add footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text(`Pagina ${i} di ${pageCount} - Rilievi & Perizie - Report generato il ${new Date().toLocaleDateString('it-IT')}`,
        doc.internal.pageSize.getWidth() / 2,
        doc.internal.pageSize.getHeight() - 10,
        { align: 'center' }
      );
    }
  }


  // Function to check if perizia was created in the current month
  function isCurrentMonth(date) {
    const now = new Date();
    const perizia = new Date(date);
    return perizia.getFullYear() === now.getFullYear() &&
      perizia.getMonth() === now.getMonth();
  }

  // Function to check if perizia was created in the current year
  function isCurrentYear(date) {
    const now = new Date();
    const perizia = new Date(date);
    return perizia.getFullYear() === now.getFullYear();
  }

  // Function to create a simple header row
  function createHeaderRow(doc, text, y) {
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text(text, 14, y);
    return y + 10;
  }

  // Update the form submission handler
  document.getElementById('eliminaPeriziaForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    // Mostra un indicatore di caricamento
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminazione...';

    try {
      const id = document.getElementById('perizia-id-elimina').value;
      const perizia = perizieData.find(p => p._id === id);

      // Check if user is allowed to delete the perizia
      if (userRole !== 'admin' && perizia.operatore !== username) {
        throw new Error('Non hai il permesso di eliminare questa perizia');
      }

      // Setup request headers
      const headers = {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      };

      // If admin, include password
      if (userRole === 'admin') {
        const password = document.getElementById('password-admin').value;
        if (!password) {
          throw new Error('Password admin richiesta');
        }
        headers['admin-password'] = password;
      }

      // Send deletion request
      const response = await inviaRichiesta("DELETE", `/api/perizie/:${id}`, null);

      if (response.ok) {
        // Chiudi il modal
        chiudiModal('eliminaPeriziaModal');

        // Ricarica le perizie
        await caricaPerizie();

        // Se la mappa è inizializzata, aggiorna i marker
        if (map) {
          addPerizieMarkers();
        }

        alert('Perizia eliminata con successo!');
      } else {
        const errorText = await response.text();
        throw new Error(errorText || 'Errore nell\'eliminazione della perizia');
      }
    } catch (err) {
      console.error('Errore:', err);
      alert('Errore: ' + (err.message || 'Si è verificato un problema durante l\'eliminazione della perizia'));
    } finally {
      // Ripristina il pulsante
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });

  // Theme toggle functionality
  document.getElementById('themeToggleBtn').addEventListener('click', function () {
    document.body.classList.toggle('dark');
    const icon = this.querySelector('i');
    if (document.body.classList.contains('dark')) {
      icon.classList.remove('fa-moon');
      icon.classList.add('fa-sun');
    } else {
      icon.classList.remove('fa-sun');
      icon.classList.add('fa-moon');
    }

    // Save preference
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
  });

  // User dropdown toggle
  document.getElementById('userDropdown').addEventListener('click', function () {
    this.classList.toggle('active');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function (e) {
    const dropdown = document.getElementById('userDropdown');
    if (!dropdown.contains(e.target)) {
      dropdown.classList.remove('active');
    }
  });

  // Check for saved theme preference
  document.addEventListener('DOMContentLoaded', function () {
    // Set user avatar initial
    const usernameElem = document.getElementById('username');
    const userAvatarElem = document.getElementById('userAvatar');

    if (username && usernameElem) {
      usernameElem.textContent = username;
      if (userAvatarElem) {
        userAvatarElem.textContent = username.charAt(0).toUpperCase();
      }
    }

    // Check for dark mode preference
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'true') {
      document.body.classList.add('dark');
      const icon = document.getElementById('themeToggleBtn').querySelector('i');
      icon.classList.remove('fa-moon');
      icon.classList.add('fa-sun');
    }

    // Check system preference
    if (darkMode === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark');
      const icon = document.getElementById('themeToggleBtn').querySelector('i');
      icon.classList.remove('fa-moon');
      icon.classList.add('fa-sun');
    }
  });

  // Improve modal animations
  function mostraModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    modal.style.display = 'flex';
    setTimeout(() => {
      modal.querySelector('.modal-content').style.transform = 'scale(1)';
    }, 10);
  }

  function chiudiModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) modalContent.style.transform = 'scale(0.95)';

    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }

  // Improve window click handling for modals
  window.addEventListener('click', function (event) {
    if (event.target.classList.contains('modal')) {
      const modalId = event.target.id;
      chiudiModal(modalId);
    }
  });

  // Ripristina la mappa - aggiungi questo script alla fine del file
  document.addEventListener('DOMContentLoaded', function () {
    // Forza la corretta visualizzazione della mappa
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      mapContainer.style.height = '400px'; // Imposta un'altezza esplicita

      // Se la mappa è già inizializzata, invalidala e ridimensionala
      if (map) {
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    }

    // Assicurati che il contenitore della mappa sia visibile
    const adminMapContainer = document.getElementById('admin-map-container');
    if (adminMapContainer) {
      adminMapContainer.style.display = 'block';
    }
  });

  // Ripristina gli event listener del menu
  document.addEventListener('DOMContentLoaded', function () {
    // Menu Perizie
    document.getElementById('menuPerizie').addEventListener('click', function (e) {
      e.preventDefault();

      // Nascondi tutte le sezioni
      document.getElementById('stats').style.display = 'none';
      document.getElementById('map-and-list-container').style.display = 'none';
      document.getElementById('clienti-section').style.display = 'none';
      document.getElementById('reportistica-section').style.display = 'none';

      // Mostra solo la sezione delle perizie
      document.getElementById('mappa-perizie-section').style.display = 'block';

      // Inizializza la mappa fullscreen
      if (typeof initFullscreenMap === 'function') {
        initFullscreenMap();
      }

      // Evidenzia il link attivo
      document.querySelectorAll('.navbar-menu-link').forEach(link => {
        link.classList.remove('active');
      });
      this.classList.add('active');
    });

    // Menu Reportistica
    document.getElementById('menuReportistica').addEventListener('click', function (e) {
      e.preventDefault();

      // Nascondi tutte le sezioni
      document.getElementById('stats').style.display = 'none';
      document.getElementById('map-and-list-container').style.display = 'none';
      document.getElementById('clienti-section').style.display = 'none';
      document.getElementById('mappa-perizie-section').style.display = 'none';

      // Mostra solo la sezione reportistica
      document.getElementById('reportistica-section').style.display = 'block';

      // Carica reportistica
      if (typeof caricaReportistica === 'function') {
        caricaReportistica();
      }

      // Evidenzia il link attivo
      document.querySelectorAll('.navbar-menu-link').forEach(link => {
        link.classList.remove('active');
      });
      this.classList.add('active');
    });

    // Menu Dashboard
    document.getElementById('menuDashboard').addEventListener('click', function (e) {
      e.preventDefault();

      // Nascondi tutte le sezioni speciali
      document.getElementById('clienti-section').style.display = 'none';
      document.getElementById('mappa-perizie-section').style.display = 'none';
      document.getElementById('reportistica-section').style.display = 'none';

      // Mostra la dashboard
      document.getElementById('stats').style.display = 'block';
      document.getElementById('map-and-list-container').style.display = 'grid';

      // Evidenzia il link attivo
      document.querySelectorAll('.navbar-menu-link').forEach(link => {
        link.classList.remove('active');
      });
      this.classList.add('active');
    });
  });

  // Assicurati che tutti gli elementi abbiano la corretta visibilità iniziale
  document.addEventListener('DOMContentLoaded', function () {
    // Fix per il contenitore principale delle perizie
    const mapAndListContainer = document.getElementById('map-and-list-container');
    if (mapAndListContainer) {
      mapAndListContainer.style.display = 'grid';
      mapAndListContainer.style.gridTemplateColumns = '1fr 1fr';
      mapAndListContainer.style.gap = '1rem';
    }

    // Fix per le statistiche
    const statsSection = document.getElementById('stats');
    if (statsSection) {
      statsSection.style.display = 'block';
    }

    // Assicurati che le altre sezioni siano nascoste
    const sectionsToHide = [
      'clienti-section',
      'mappa-perizie-section',
      'reportistica-section'
    ];

    sectionsToHide.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.style.display = 'none';
      }
    });
  });

  // Aggiungi questo script all'inizio del file o nella console per un fix immediato
  document.addEventListener('DOMContentLoaded', function () {
    console.log("Esecuzione fix per navbar e mappa");

    // FIX NAVBAR: Assicurati che esista nella struttura della pagina
    const navbar = document.querySelector('.navbar-fixed');
    if (!navbar) {
      console.error("Navbar non trovata, creazione in corso...");

      // Crea la navbar mancante
      const navbarHTML = `
      <nav class="navbar-fixed" style="display:block !important; z-index:9999 !important;">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
          <a href="#" class="navbar-logo">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
              <path d="M12 2L4 5V11.09C4 16.14 7.41 20.85 12 22C16.59 20.85 20 16.14 20 11.09V5L12 2Z" fill="currentColor" opacity="0.4"/>
              <path d="M12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17Z" fill="currentColor"/>
              <path d="M14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6193 14.5 9.5 13.3807 9.5 12C9.5 10.6193 10.6193 9.5 12 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <span>Rilievi & Perizie</span>
          </a>
          
          <ul class="navbar-menu hidden md:flex">
            <li class="navbar-menu-item">
              <a href="#" id="menuDashboard" class="navbar-menu-link active">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="navbar-menu-item">
              <a href="#" id="menuPerizie" class="navbar-menu-link">
                <i class="fas fa-map-marked-alt"></i>
                <span>Perizie</span>
              </a>
            </li>
            <li class="navbar-menu-item">
              <a href="#" id="menuClienti" class="navbar-menu-link">
                <i class="fas fa-users"></i>
                <span>Clienti</span>
              </a>
            </li>
            <li class="navbar-menu-item">
              <a href="#" id="menuReportistica" class="navbar-menu-link">
                <i class="fas fa-chart-bar"></i>
                <span>Reportistica</span>
              </a>
            </li>
          </ul>
          
          <div class="navbar-right">
            <button id="themeToggleBtn" class="theme-toggle-btn">
              <i class="fas fa-moon"></i>
            </button>
            
            <div class="user-dropdown" id="userDropdown">
              <button class="user-dropdown-btn">
                <div class="avatar" id="userAvatar">U</div>
                <span id="username">Utente</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
              </button>
            </div>
          </div>
        </div>
      </nav>
    `;

      // Inserisci la navbar all'inizio del body
      document.body.insertAdjacentHTML('afterbegin', navbarHTML);
    } else {
      // Se la navbar esiste ma è nascosta, rendila visibile
      navbar.style.display = 'block';
      navbar.style.zIndex = '9999';
      navbar.style.position = 'fixed';
      navbar.style.top = '0';
      navbar.style.width = '100%';
    }

    // FIX MAPPA: Assicurati che i contenitori della mappa siano visibili
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      mapContainer.style.display = 'block';
      mapContainer.style.height = '400px';
      mapContainer.style.width = '100%';
    }

    const adminMapContainer = document.getElementById('admin-map-container');
    if (adminMapContainer) {
      adminMapContainer.style.display = 'block';
    }

    const mapFullscreenContainer = document.getElementById('mapFullscreen');
    if (mapFullscreenContainer) {
      mapFullscreenContainer.style.height = '75vh';
      mapFullscreenContainer.style.width = '100%';
    }

    // FIX EVENT LISTENERS: Aggiungi gestori eventi sicuri (null-safe)
    const addSafeEventListener = function (id, eventType, handler) {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener(eventType, handler);
        console.log(`Event listener aggiunto con successo a: ${id}`);
      } else {
        console.warn(`Elemento non trovato: ${id}`);
      }
    };

    // Gestori eventi per i menu
    const menuItems = ['menuDashboard', 'menuPerizie', 'menuClienti', 'menuReportistica'];
    menuItems.forEach(id => {
      addSafeEventListener(id, 'click', function (e) {
        e.preventDefault();
        console.log(`Click su ${id}`);

        // Rimuovi classe active da tutti i menu
        menuItems.forEach(menuId => {
          const menuElement = document.getElementById(menuId);
          if (menuElement) menuElement.classList.remove('active');
        });

        // Aggiungi classe active a questo menu
        this.classList.add('active');

        // Gestisci visibilità sezioni
        if (id === 'menuDashboard') {
          setVisibility('stats', 'block');
          setVisibility('map-and-list-container', 'grid');
          setVisibility('clienti-section', 'none');
          setVisibility('mappa-perizie-section', 'none');
          setVisibility('reportistica-section', 'none');
        } else if (id === 'menuPerizie') {
          setVisibility('stats', 'none');
          setVisibility('map-and-list-container', 'none');
          setVisibility('clienti-section', 'none');
          setVisibility('mappa-perizie-section', 'block');
          setVisibility('reportistica-section', 'none');
          // Inizializza mappa fullscreen se esiste la funzione
          if (typeof initFullscreenMap === 'function') {
            initFullscreenMap();
          }
        } else if (id === 'menuClienti') {
          setVisibility('stats', 'none');
          setVisibility('map-and-list-container', 'none');
          setVisibility('clienti-section', 'block');
          setVisibility('mappa-perizie-section', 'none');
          setVisibility('reportistica-section', 'none');
          // Carica clienti se necessario
          if (typeof caricaClienti === 'function') {
            caricaClienti();
          }
        } else if (id === 'menuReportistica') {
          setVisibility('stats', 'none');
          setVisibility('map-and-list-container', 'none');
          setVisibility('clienti-section', 'none');
          setVisibility('mappa-perizie-section', 'none');
          setVisibility('reportistica-section', 'block');
          // Carica reportistica se necessario
          if (typeof caricaReportistica === 'function') {
            caricaReportistica();
          }
        }
      });
    });

    // Helper function per impostare la visibilità
    function setVisibility(id, display) {
      const element = document.getElementById(id);
      if (element) element.style.display = display;
    }

    // Se la mappa esiste ma non è inizializzata, forza l'inizializzazione
    if (typeof map === 'undefined' || map === null) {
      console.log("Forzo inizializzazione della mappa");
      if (typeof initMap === 'function') {
        initMap();
      } else if (typeof checkLogin === 'function') {
        checkLogin(); // La checkLogin dovrebbe inizializzare anche la mappa
      }
    } else if (map) {
      console.log("Invalido dimensioni mappa esistente");
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    // Fix layout container principale
    const mainContainer = document.getElementById('map-and-list-container');
    if (mainContainer) {
      mainContainer.style.display = 'grid';
      mainContainer.style.gridTemplateColumns = '1fr 1fr';
      mainContainer.style.gap = '1rem';
    }
  });

  let immaginiDaEliminare = [];
  // Add this function to your script section
  async function modificaPerizia(id) {
    // Reset dell'array delle immagini da eliminare ad ogni apertura del modal
    immaginiDaEliminare = [];

    try {
      // Show loading in the modal
      document.getElementById('immagini-modifica-container').innerHTML = `
    <div class="flex items-center justify-center p-6 bg-gray-50 rounded-md">
      <div class="text-center text-gray-500">
        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
        <p>Caricamento dati in corso...</p>
      </div>
    </div>
  `;

      // Show the modal
      document.getElementById('modificaPeriziaModal').style.display = 'flex';
      setTimeout(() => {
        document.querySelector('#modificaPeriziaModal .modal-content').style.transform = 'scale(1)';
      }, 10);

      // Fetch perizia details
      const response = await fetch(`/api/perizie/${id}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (!response.ok) {
        throw new Error('Errore nel caricamento dei dati della perizia');
      }

      const perizia = await response.json();

      // Populate form fields
      document.getElementById('perizia-id-modifica').value = perizia._id;
      document.getElementById('descrizione-modifica').value = perizia.descrizione;
      document.getElementById('cliente-modifica').value = perizia.cliente || '';
      document.getElementById('indirizzo-modifica').value = perizia.indirizzo || '';
      document.getElementById('stato-modifica').value = perizia.stato || 'In attesa';

      // Set coordinates
      if (perizia.coordinate && perizia.coordinate.length === 2) {
        document.getElementById('latitudine-modifica').value = perizia.coordinate[0];
        document.getElementById('longitudine-modifica').value = perizia.coordinate[1];
      } else {
        document.getElementById('latitudine-modifica').value = '';
        document.getElementById('longitudine-modifica').value = '';
      }

      // Carica le immagini
      const immaginiContainer = document.getElementById('immagini-modifica-container');
      immaginiContainer.innerHTML = '';

      if (perizia.immagini && perizia.immagini.length > 0) {
        perizia.immagini.forEach((immagine, index) => {
          const imgElement = document.createElement('div');
          imgElement.className = 'immagine-container relative mb-2';
          imgElement.dataset.id = immagine.id || index;
          imgElement.dataset.path = immagine.url || '';  // Aggiungi il percorso come attributo
          imgElement.dataset.filename = immagine.filename || ''; // Aggiungi il filename se disponibile
          imgElement.innerHTML = `
            <img src="${immagine.url}" alt="Immagine perizia" class="w-full h-32 object-cover rounded-md">
            <button type="button" class="rimuovi-immagine-btn absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">
              <i class="fas fa-times"></i>
            </button>
          `;
          immaginiContainer.appendChild(imgElement);
        });

        // Aggiungi event listener ai pulsanti di eliminazione
        document.querySelectorAll('.rimuovi-immagine-btn').forEach(btn => {
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation(); // Importante: blocca la propagazione dell'evento

            const container = this.closest('.immagine-container');
            const imageId = container.dataset.id;

            // Aggiungi l'id dell'immagine all'array delle immagini da eliminare
            immaginiDaEliminare.push(imageId);

            // Nascondi visivamente l'immagine
            container.style.opacity = '0.3';
            container.classList.add('to-be-removed');

            // Feedback visivo
            const statusBadge = document.createElement('div');
            statusBadge.className = 'absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded';
            statusBadge.textContent = 'Da eliminare';
            container.appendChild(statusBadge);

            // Cambia l'icona e la funzione del pulsante per permettere di annullare l'eliminazione
            this.innerHTML = '<i class="fas fa-undo"></i>';
            this.classList.remove('bg-red-500');
            this.classList.add('bg-blue-500');

            this.onclick = function (e) {
              e.preventDefault();
              e.stopPropagation();

              // Rimuovi l'id dall'array delle immagini da eliminare
              const index = immaginiDaEliminare.indexOf(imageId);
              if (index > -1) {
                immaginiDaEliminare.splice(index, 1);
              }

              // Ripristina l'aspetto dell'immagine
              container.style.opacity = '1';
              container.classList.remove('to-be-removed');
              container.querySelector('.absolute.top-2.left-2').remove();

              // Ripristina l'icona e la funzione del pulsante
              this.innerHTML = '<i class="fas fa-times"></i>';
              this.classList.remove('bg-blue-500');
              this.classList.add('bg-red-500');

              // Reimposta la funzione originale del pulsante (ricorsivo)
              this.onclick = btn.onclick;
            };
          });
        });
      } else {
        immaginiContainer.innerHTML = '<p class="text-gray-500">Nessuna immagine caricata</p>';
      }

      // Se l'utente è admin, mostra un campo per riassegnare la perizia
      if (userRole === 'admin') {
        // Crea il container per il selettore operatore se non esiste
        let operatoreField = document.getElementById('operatore-modifica-container');
        if (!operatoreField) {
          operatoreField = document.createElement('div');
          operatoreField.id = 'operatore-modifica-container';
          operatoreField.innerHTML = `
          <label for="operatore-modifica" class="block text-sm font-medium text-gray-700">Assegnata a</label>
          <select id="operatore-modifica" name="operatore"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="">Caricamento operatori...</option>
          </select>
        `;

          // Inserisci prima del campo stato
          const statoField = document.querySelector('#modificaPeriziaForm div:has(#stato-modifica)');
          if (statoField) {
            statoField.parentNode.insertBefore(operatoreField, statoField);
          }

          // Carica gli operatori
          const response = await fetch('/api/users?role=operatore', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (response.ok) {
            const users = await response.json();
            const select = document.getElementById('operatore-modifica');

            // Pulisci il select
            select.innerHTML = '';

            // Aggiungi gli operatori
            users.forEach(user => {
              const option = document.createElement('option');
              option.value = user.username;
              option.textContent = user.username;
              // Seleziona l'operatore attuale
              if (perizia.operatore === user.username) {
                option.selected = true;
              }
              select.appendChild(option);
            });
          } else {
            console.error('Errore nel caricamento degli operatori');
          }
        }
      }

    } catch (err) {
      console.error('Errore nella modifica della perizia:', err);
      alert('Errore: ' + (err.message || 'Si è verificato un problema durante il caricamento dei dati della perizia'));

      // Close the modal
      chiudiModal('modificaPeriziaModal');
    }
  }
  // Aggiungi questo script per rilevare il tipo di dispositivo e adattare l'interfaccia
  document.addEventListener('DOMContentLoaded', function () {
    const isMobile = window.innerWidth < 768;
    const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;

    // Applica classe al body per permettere styling CSS specifico
    document.body.classList.toggle('mobile-device', isMobile);
    document.body.classList.toggle('tablet-device', isTablet);

    // Adatta elementi specifici in base al dispositivo
    adjustUIForDevice(isMobile, isTablet);

    // Informa mappe e grafici del cambio di dimensioni
    if (map) map.invalidateSize();
    if (mapFullscreen) mapFullscreen.invalidateSize();
  });

  // Funzione per adattare l'interfaccia
  function adjustUIForDevice(isMobile, isTablet) {
    // Adatta container mappa
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      mapContainer.style.height = isMobile ? '300px' : '400px';
    }

    // Adatta stile delle tabelle
    const tables = document.querySelectorAll('table');
    tables.forEach(table => {
      if (isMobile) {
        table.classList.add('mobile-optimized');
      } else {
        table.classList.remove('mobile-optimized');
      }
    });
  }

  // Ridimensiona l'interfaccia quando la finestra cambia dimensione
  window.addEventListener('resize', function () {
    const isMobile = window.innerWidth < 768;
    const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;

    document.body.classList.toggle('mobile-device', isMobile);
    document.body.classList.toggle('tablet-device', isTablet);

    adjustUIForDevice(isMobile, isTablet);

    if (map) map.invalidateSize();
    if (mapFullscreen) mapFullscreen.invalidateSize();
  });

  // Find and update the removeBtn click handler in the modificaPerizia function
  // This function marks images for deletion properly
  function setupImageRemoveButton(imgGroup, removeBtn) {
    removeBtn.addEventListener('click', function () {
      if (confirm('Sei sicuro di voler rimuovere questa immagine?')) {
        // Set deletion flag in multiple ways to ensure compatibility
        imgGroup.dataset.toRemove = 'true';
        imgGroup.setAttribute('data-to-remove', 'true');
        imgGroup.style.opacity = '0.5';

        // Change button appearance and text
        removeBtn.textContent = 'Annulla rimozione';
        removeBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        removeBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');

        // Set up cancel removal functionality
        removeBtn.onclick = function () {
          // Clear deletion flags
          imgGroup.dataset.toRemove = 'false';
          imgGroup.removeAttribute('data-to-remove');
          imgGroup.style.opacity = '1';

          // Restore button
          removeBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> Rimuovi';
          removeBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
          removeBtn.classList.add('bg-red-600', 'hover:bg-red-700');

          // Restart with original handler
          removeBtn.onclick = null;
          setupImageRemoveButton(imgGroup, removeBtn);
        };
      }
    });
  }

  // Call this in modificaPerizia() when creating remove buttons
  const removeBtn = imgGroup.querySelector('.rimuovi-immagine-btn');
  setupImageRemoveButton(imgGroup, removeBtn);


  // Aggiungi questo nel tuo <script> dopo le altre funzioni
  //
  // Funzione per mostrare il modal di creazione utente (solo admin)
  function mostraCreaUtenteModal() {
    if (userRole !== 'admin') {
      alert("Solo gli amministratori possono creare nuovi utenti");
      return;
    }

    document.getElementById('creaUtenteModal').style.display = 'flex';
    setTimeout(() => {
      document.querySelector('#creaUtenteModal .modal-content').style.transform = 'scale(1)';
    }, 10);
  }

  // Sostituisci il codice esistente per la gestione del menu mobile con questo
  document.addEventListener('DOMContentLoaded', function () {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const navbarMenu = document.querySelector('.navbar-menu');

    // Assicurati che il menu sia nascosto all'inizio in modalità mobile
    if (window.innerWidth < 768 && navbarMenu) {
      navbarMenu.classList.add('hidden');
      navbarMenu.classList.remove('mobile-menu-open');
    }

    if (mobileMenuToggle && navbarMenu) {
      // Gestore per il pulsante hamburger
      mobileMenuToggle.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        navbarMenu.classList.toggle('hidden');
        navbarMenu.classList.toggle('mobile-menu-open');
      });

      // Chiudi menu quando si clicca su un link
      const menuLinks = navbarMenu.querySelectorAll('a');
      menuLinks.forEach(link => {
        link.addEventListener('click', function () {
          if (window.innerWidth < 768) {
            navbarMenu.classList.add('hidden');
            navbarMenu.classList.remove('mobile-menu-open');
          }
        });
      });

      // Chiudi menu quando si clicca fuori
      document.addEventListener('click', function (e) {
        if (window.innerWidth < 768 &&
          !navbarMenu.contains(e.target) &&
          !mobileMenuToggle.contains(e.target) &&
          !navbarMenu.classList.contains('hidden')) {
          navbarMenu.classList.add('hidden');
          navbarMenu.classList.remove('mobile-menu-open');
        }
      });
    }

    // Gestisci il cambio di dimensioni della finestra
    window.addEventListener('resize', function () {
      if (navbarMenu) {
        if (window.innerWidth >= 768) {
          // In desktop mode, show the menu
          navbarMenu.classList.remove('hidden');
          navbarMenu.classList.remove('mobile-menu-open');
        } else {
          // In mobile mode, hide the menu if it's not explicitly opened
          if (!navbarMenu.classList.contains('mobile-menu-open')) {
            navbarMenu.classList.add('hidden');
          }
        }
      }
    });
  });
  </script>
  <style>
     /* Modern and futuristic styles for Rilievi & Perizie */
 :root {
    --primary: #4F46E5;
    --primary-light: #818CF8;
    --primary-dark: #4338CA;
    --secondary: #10B981;
    --secondary-light: #34D399;
    --secondary-dark: #059669;
    --dark: #1E293B;
    --light: #F8FAFC;
    --surface: #FFFFFF;
    --surface-alt: #F1F5F9;
    --error: #EF4444;
    --warn: #F59E0B;
    --success: #10B981;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-400: #9CA3AF;
    --gray-500: #6B7280;
    --gray-600: #4B5563;
    --gray-700: #374151;
    --gray-800: #1F2937;
    --gray-900: #111827;
  }

  /* Dark mode variables */
  .dark {
    --primary: #6366F1;
    --primary-light: #A5B4FC;
    --primary-dark: #4F46E5;
    --secondary: #34D399;
    --secondary-light: #6EE7B7;
    --secondary-dark: #10B981;
    --dark: #F8FAFC;
    --light: #0F172A;
    --surface: #1E293B;
    --surface-alt: #334155;
    --gray-50: #0F172A;
    --gray-100: #1E293B;
    --gray-200: #334155;
    --gray-300: #475569;
    --gray-400: #64748B;
    --gray-500: #94A3B8;
    --gray-600: #CBD5E1;
    --gray-700: #E2E8F0;
    --gray-800: #F1F5F9;
    --gray-900: #F8FAFC;
  }

  html,
  body {
    font-family: 'Outfit', sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease;
    margin-bottom: 8%;
    margin-top: -1%;
  }

  body {
    background: var(--light);
    color: var(--dark);
    padding-top: 0 !important;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow-x: hidden;
  }

  /* Fix for map legend text color in dark mode */
  body.dark .leaflet-control.legend,
  body.dark .leaflet-control.topzones,
  body.dark .leaflet-control.info {
    color: #000 !important;
    /* Black text for legend in dark mode */
    background-color: #f1f5f9 !important;
    /* Light background for contrast */
  }

  /* Fix for popup content text in dark mode */
  body.dark .leaflet-popup-content {
    color: #000 !important;
    /* Black text for popups */
  }

  body.dark .map-legend,
  body.dark .map-legend div,
  body.dark .map-legend span,
  body.dark .map-legend p {
    color: #000 !important;
  }

  /* Dark mode styles for containers */
  body.dark {
    background-color: var(--light) !important;
    color: var(--dark) !important;
  }

  /* Background containers */
  body.dark .bg-white,
  body.dark .bg-gray-100,
  body.dark .card,
  body.dark .stats-card {
    background-color: var(--surface) !important;
    color: var(--dark) !important;
  }

  /* Section containers */
  body.dark #stats .overflow-hidden,
  body.dark #clienti-section,
  body.dark #reportistica-section,
  body.dark #mappa-perizie-section,
  body.dark .perizie-table-container,
  body.dark .modal-content {
    background-color: var(--surface) !important;
    color: var(--dark) !important;
  }

  /* Table elements */
  body.dark table,
  body.dark tbody {
    background-color: var(--surface) !important;
    color: var(--dark) !important;
  }

  body.dark table th {
    background-color: var(--gray-100) !important;
    color: var(--gray-800) !important;
  }

  body.dark table td {
    color: var(--gray-600) !important;
    border-color: var(--gray-200) !important;
  }

  body.dark tr:hover td {
    background-color: var(--gray-100) !important;
  }

  /* Modal elements */
  body.dark .modal-header {
    border-color: var(--gray-200) !important;
  }

  body.dark .close {
    color: var(--gray-400) !important;
  }

  body.dark .close:hover,
  body.dark .close:focus {
    color: var(--gray-700) !important;
  }

  /* Adjust text colors */
  body.dark .text-gray-500 {
    color: var(--gray-400) !important;
  }

  body.dark .text-gray-600,
  body.dark .text-gray-700 {
    color: var(--gray-300) !important;
  }

  body.dark .text-gray-800,
  body.dark .text-gray-900 {
    color: var(--gray-200) !important;
  }

  /* Footer adjustments */
  body.dark footer {
    background-color: var(--surface) !important;
    border-color: var(--gray-200) !important;
  }

  body.dark .leaflet-popup-content {
    color: #f8fafc !important;
    /* Testo chiaro per i popup in dark mode */
  }

  body.dark .leaflet-popup-content-wrapper {
    background-color: #1e293b !important;
    /* Sfondo scuro per i popup */
    border-color: #475569 !important;
  }

  body.dark .leaflet-popup-tip {
    background-color: #1e293b !important;
    /* Punta del popup in dark mode */
  }

  /* Fix per i bottoni nei popup */
  body.dark .leaflet-popup-content button {
    background-color: #3b82f6 !important;
    color: #ffffff !important;
  }


  /* Mantieni i colori degli stati delle perizie anche in dark mode */
  .bg-green-100.text-green-800,
  body.dark .bg-green-100.text-green-800 {
    background-color: rgba(16, 185, 129, 0.2) !important;
    color: #10b981 !important;
  }

  .bg-blue-100.text-blue-800,
  body.dark .bg-blue-100.text-blue-800 {
    background-color: rgba(59, 130, 246, 0.2) !important;
    color: #3b82f6 !important;
  }

  .bg-yellow-100.text-yellow-800,
  body.dark .bg-yellow-100.text-yellow-800 {
    background-color: rgba(245, 158, 11, 0.2) !important;
    color: #f59e0b !important;
  }

  /* Animated background shapes */
  .bg-shapes {
    position: fixed;
    top: 0;
    font-weight: 600;
    font-size: 1.25rem;
    color: var(--primary);
    text-decoration: none;
    z-index: -1 !important;
    pointer-events: none;
  }

  .navbar-logo svg {
    width: 32px;
    height: 32px;
    margin-right: 0.75rem;
  }

  .navbar-menu {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 1rem;
  }

  .navbar-menu-item {
    position: relative;
  }

  .navbar-menu-link {
    padding: 0.5rem 1rem;
    color: var(--gray-600);
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .navbar-menu-link:hover {
    color: var(--primary);
    background: var(--surface-alt);
  }

  .navbar-menu-link.active {
    color: var(--primary);
    background: rgba(79, 70, 229, 0.1);
  }

  .navbar-menu-link.active::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--primary);
  }

  .navbar-fixed {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: auto;
    z-index: 9999 !important;
    /* Increased z-index to ensure it stays on top */
    background: rgba(255, 255, 255, 0.9);
    /* Slightly more opaque */
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(229, 231, 235, 0.5);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 0;
    transition: all 0.3s ease;
  }

  .navbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .theme-toggle-btn {
    background: none;
    border: none;
    color: var(--gray-600);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .theme-toggle-btn:hover {
    background: var(--surface-alt);
    color: var(--primary);
  }

  .user-dropdown {
    position: relative;
  }

  .user-dropdown-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--gray-700);
  }

  .user-dropdown-btn:hover {
    background: var(--surface-alt);
  }

  .user-dropdown-btn .avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .user-dropdown-content {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    width: 220px;
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    padding: 0.5rem;
    z-index: 1000;
    transform-origin: top right;
    transform: scale(0.95);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
  }

  .user-dropdown.active .user-dropdown-content {
    transform: scale(1);
    opacity: 1;
    visibility: visible;
  }

  .user-dropdown-item {
    padding: 0.75rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--gray-700);
  }

  .user-dropdown-item:hover {
    background: var(--surface-alt);
    color: var(--primary);
  }

  .user-dropdown-item.danger {
    color: var(--error);
  }

  .user-dropdown-item.danger:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  /* Main container */
  main {
    margin-top: 60px !important;
    flex: 1;
    padding: 2rem;
    max-width: 1440px;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    position: absolute;
    z-index: 1;
    min-height: calc(100vh - 140px);
  }

  body.dark .navbar-fixed {
    background: rgba(30, 41, 59, 0.95);
    /* More opaque in dark mode */
  }

  .navbar-fixed .container {
    /*ancora la navbar*/
    height: 70px;
    display: flex;
    align-items: center;
  }

  /* Card styling */
  .card {
    background: var(--surface);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  }

  .card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-title {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-title i {
    color: var(--primary);
  }

  .card-body {
    padding: 1.5rem;
  }

  /* Stats cards */
  .stats-card {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  }

  .stats-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .stats-card:nth-child(1) .stats-card-icon {
    background: rgba(79, 70, 229, 0.1);
    color: var(--primary);
  }

  .stats-card:nth-child(2) .stats-card-icon {
    background: rgba(16, 185, 129, 0.1);
    color: var(--secondary);
  }

  .stats-card:nth-child(3) .stats-card-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warn);
  }

  .stats-card-content {
    flex: 1;
  }

  .stats-card-label {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin: 0 0 0.25rem;
  }

  .stats-card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
  }

  /* Button styling */
  .btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
  }

  .btn-secondary {
    background: var(--surface-alt);
    color: var(--gray-700);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
  }

  .btn-danger {
    background: var(--error);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
  }

  /* Modal styling */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
  }

  /* Map container styling */
  .map-container {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  /* Table styling */
  .table-container {
    overflow-x: auto;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  table th {
    text-align: left;
    padding: 1rem;
    font-weight: 600;
    color: var(--gray-700);
    background: var(--gray-50);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  table th:first-child {
    border-top-left-radius: 16px;
  }

  table th:last-child {
    border-top-right-radius: 16px;
  }

  table td {
    padding: 1rem;
    border-top: 1px solid var(--gray-100);
    color: var(--gray-700);
  }

  table tr:hover td {
    background: var(--gray-50);
  }

  /* Loading indicator */
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(79, 70, 229, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
  }
/* Fix globale per i colori testo in dark mode */
body.dark {
color: #f8fafc !important;
}

/* Fix specifici per i contenuti delle card e tabelle */
body.dark .card h2,
body.dark .card h3,
body.dark .card p,
body.dark .card div:not(.bg-blue-100):not(.bg-green-100):not(.bg-yellow-100),
body.dark .stats-card-value,
body.dark .text-gray-700,
body.dark .text-gray-800,
body.dark .text-gray-900 {
color: #f8fafc !important;
}

/* Fix per le tabelle */
body.dark table th {
background-color: #334155 !important;
color: #f8fafc !important;
}

body.dark table td {
color: #e2e8f0 !important;
}

/* Fix specificamente per le legende di mappa */
body.dark .leaflet-control.legend,
body.dark .leaflet-control.topzones,
body.dark .leaflet-control.info {
background-color: #1e293b !important;
color: #f8fafc !important;
border: 1px solid #475569;
}

/* Fix per le legende interne e divisori */
body.dark .legend div,
body.dark .legend span,
body.dark .legend i,
body.dark .topzones div,
body.dark .info div {
color: #f8fafc !important;
border-color: #475569 !important;
}

/* Fix per i popup della mappa */
body.dark .leaflet-popup-content {
color: #f8fafc !important;
}

body.dark .leaflet-popup-content-wrapper,
body.dark .leaflet-popup-tip {
background-color: #1e293b !important;
border-color: #475569 !important;
}

/* Fix per i grafici e le statistiche nella pagina profilo */
body.dark .profile-card .text-gray-700,
body.dark .profile-card .text-gray-800,
body.dark .profile-card .text-gray-900,
body.dark .profile-stats-card,
body.dark .chart-container text {
color: #f8fafc !important;
}

/* Mantieni lo stile corretto per i badge colorati di stato */
body.dark .bg-green-100.text-green-800,
body.dark .bg-blue-100.text-blue-800,
body.dark .bg-yellow-100.text-yellow-800 {
/* Conserva lo sfondo ma con trasparenza maggiore */
background-color: rgba(16, 185, 129, 0.2) !important;
color: #10b981 !important; /* Verde più brillante */
}

body.dark .bg-blue-100.text-blue-800 {
background-color: rgba(59, 130, 246, 0.2) !important;
color: #3b82f6 !important; /* Blu più brillante */
}

body.dark .bg-yellow-100.text-yellow-800 {
background-color: rgba(245, 158, 11, 0.2) !important;
color: #f59e0b !important; /* Giallo più brillante */
}
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Footer styling */
  /* Fix for footer to stay at the bottom */
  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: var(--surface);
    border-top: 1px solid var(--gray-100);
    z-index: 10;
    padding: 1rem 0;
  }

  /* Fix for dark mode */
  body.dark footer {
    background-color: var(--surface) !important;
    border-color: var(--gray-200) !important;
  }

  /* Add animated scroll indicator on tables with overflow */
  .has-scroll::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--primary-light) 50%, transparent 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: 100% 0;
    }

    100% {
      background-position: -100% 0;
    }
  }

  /* Text color fixes for dark mode */
  body.dark {
    color: #f8fafc !important;
    /* Default white text for everything */
  }

  /* Keep form elements with dark text */
  body.dark input,
  body.dark select,
  body.dark textarea,
  body.dark option {
    color: #1e293b !important;
    background-color: #f1f5f9 !important;
  }

  /* Ensure text elements have proper contrast */
  body.dark h1,
  body.dark h2,
  body.dark h3,
  body.dark h4,
  body.dark h5,
  body.dark h6,
  body.dark p,
  body.dark span:not(.text-gray-500):not(.text-gray-600):not(.text-gray-700),
  body.dark div:not(.text-gray-500):not(.text-gray-600):not(.text-gray-700),
  body.dark a:not(.text-gray-500):not(.text-gray-600):not(.text-gray-700),
  body.dark li,
  body.dark label,
  body.dark th,
  body.dark td {
    color: #f8fafc !important;
  }

  /* Fix specific gray text elements */
  body.dark .text-gray-500,
  body.dark .text-gray-600,
  body.dark .text-gray-700 {
    color: #cbd5e1 !important;
    /* Light gray for previously dark gray text */
  }

  /* Fix dark colored card titles and texts */
  body.dark .card-title,
  body.dark .stats-card-value {
    color: #f8fafc !important;
  }

  body.dark .stats-card-label {
    color: #cbd5e1 !important;
  }

  /* Table header text in dark mode */
  body.dark thead th {
    color: #f1f5f9 !important;
  }

  /* Modal close button */
  body.dark .close {
    color: #f8fafc !important;
  }

  /* Fix dropdown text colors */
  body.dark .user-dropdown-item {
    color: #f8fafc !important;
  }


  /* Regole CSS mobili */
  /* Aggiungi questo al tuo CSS esistente */
  @media (max-width: 767px) {
    .navbar-menu {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      flex-direction: column;
      background-color: var(--surface);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
      padding: 0.5rem 0;
    }

    .navbar-menu.hidden {
      display: none !important;
    }

    .navbar-menu.mobile-menu-open {
      display: flex !important;
    }
  }

  @media (max-width: 767px) {
    .navbar-fixed .container {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    .navbar-menu {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      flex-direction: column;
      background-color: var(--surface);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
      padding: 0.5rem 0;
    }

    .navbar-menu.mobile-menu-open {
      display: flex !important;
    }

    .navbar-menu-item {
      width: 100%;
      margin: 0;
    }

    .navbar-menu-link {
      width: 100%;
      padding: 0.75rem 1.5rem;
      border-radius: 0;
    }

    #map-and-list-container {
      grid-template-columns: 1fr !important;
      gap: 1rem !important;
    }

    .modal-content {
      width: 95% !important;
      margin: 5% auto !important;
      max-height: 90vh;
      overflow-y: auto;
    }

    .stats-card {
      margin-bottom: 1rem;
    }

    /* Per le tabelle orizzontali su mobile */
    .mobile-optimized {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  /* Regole CSS per tablet */
  @media (min-width: 768px) and (max-width: 1023px) {
    #map-and-list-container {
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  }

  /* Stili per rendere l'interfaccia touch-friendly */
  @media (max-width: 767px) {

    /* Nascondi colonne meno importanti su mobile */
    .hidden-mobile {
      display: none !important;
    }

    /* Aumenta dimensione pulsanti per touch */
    button,
    .btn,
    .navbar-menu-link {
      min-height: 44px;
      /* Altezza minima per area touch */
    }

    /* Aumenta dimensione input per touch */
    input,
    select {
      min-height: 44px;
      font-size: 16px !important;
      /* Previene lo zoom automatico su iOS */
    }

    /* Adatta spaziature per mobile */
    .px-6 {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    /* Fix per modal su mobile */
    .modal-content {
      padding: 1rem !important;
    }

    /* Migliora leggibilità su mobile */
    p,
    .text-sm {
      font-size: 1rem !important;
      line-height: 1.5 !important;
    }

    /* Miglioramenti per dropdown su mobile */
    .user-dropdown-content {
      width: 90vw !important;
      max-width: 300px !important;
      right: 0 !important;
    }

    /* Miglioramenti per grafici su mobile */
    #chart-trend,
    #chart-status,
    #chart-operators,
    #chart-geography {
      height: 200px !important;
    }
  }
  </style>
</body>

</html>